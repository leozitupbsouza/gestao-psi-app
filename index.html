<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, interactive-widget=resizes-content">
    <title>Gestão Psicologia Escolar</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <style>
        /* --- ESTILOS GERAIS --- */
        :root {
            --primary: #0d9488;
            --primary-dark: #0f766e;
            --primary-soft: #ccfbf1;
            --bg-body: #f3f4f6;
            --bg-surface: #ffffff;
            --text-main: #1e293b;
            --text-muted: #64748b;
            --border-color: #e2e8f0;
            --shadow-sm: 0 1px 3px rgba(0,0,0,0.05);
            --shadow-md: 0 4px 6px -1px rgba(0,0,0,0.05), 0 2px 4px -1px rgba(0,0,0,0.03);
            --radius: 12px; 
            --container-width: 1000px; /* Largura contida para leitura confortável */
        }

        * { box-sizing: border-box; outline: none; -webkit-tap-highlight-color: transparent; }
        
        body { 
            background-color: var(--bg-body); 
            color: var(--text-main); 
            margin: 0; 
            height: 100dvh; 
            font-family: 'Inter', sans-serif;
            display: flex; 
            flex-direction: column; 
            overflow: hidden; 
        }

        /* Scrollbar */
        ::-webkit-scrollbar { width: 6px; height: 6px; }
        ::-webkit-scrollbar-track { background: transparent; }
        ::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 10px; }
        ::-webkit-scrollbar-thumb:hover { background: #94a3b8; }

        /* Login */
        #login-screen { position: fixed; inset: 0; background: var(--bg-body); display: flex; justify-content: center; align-items: center; z-index: 2000; }
        .login-box { background: var(--bg-surface); padding: 3rem; border-radius: 24px; width: 90%; max-width: 400px; text-align: center; box-shadow: var(--shadow-md); border: 1px solid var(--border-color); }
        .login-input { width: 100%; padding: 18px; margin: 20px 0; border: 2px solid var(--border-color); border-radius: var(--radius); font-size: 16px; text-align: center; background: #f8fafc; }
        .login-input:focus { border-color: var(--primary); background: white; }
        
        /* Header Principal */
        header { 
            background: var(--bg-surface); height: 70px; 
            border-bottom: 1px solid var(--border-color); 
            display: flex; justify-content: center; align-items: center; 
            flex-shrink: 0; z-index: 20; padding: 0 20px;
        }
        .header-content { width: 100%; max-width: 1200px; display: flex; justify-content: space-between; align-items: center; }
        
        #header-dashboard { width: 100%; display: flex; justify-content: space-between; align-items: center; }
        .brand-logo { font-size: 1.2rem; font-weight: 700; display: flex; align-items: center; gap: 10px; color: var(--text-main); }
        
        #header-school { display: none; width: 100%; justify-content: space-between; align-items: center; }
        #current-school-name { font-size: 1.2rem; font-weight: 700; margin: 0 15px; text-align: center; flex: 1; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }

        /* Conteúdo Principal Scrollável */
        #app-content { flex: 1; overflow-y: auto; overflow-x: hidden; position: relative; scroll-behavior: smooth; }

        /* --- DASHBOARD (Lista de Escolas) --- */
        #dashboard-view { padding: 40px 20px; }
        .container-center { max-width: 1200px; margin: 0 auto; }
        .section-header { text-align: center; margin-bottom: 40px; }
        .section-header h2 { font-size: 1.8rem; margin: 0 0 8px 0; }
        .school-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(300px, 1fr)); gap: 20px; }
        .school-card { background: var(--bg-surface); padding: 25px; border-radius: var(--radius); border: 1px solid var(--border-color); cursor: pointer; transition: 0.2s; display: flex; flex-direction: column; justify-content: space-between; min-height: 160px; box-shadow: var(--shadow-sm); }
        .school-card:hover { transform: translateY(-3px); box-shadow: var(--shadow-md); border-color: var(--primary); }

        /* --- VISÃO DA ESCOLA (Abas no Topo) --- */
        #school-view { display: none; flex-direction: column; height: 100%; }
        
        /* Barra de Semanas (Topo) */
        .week-bar-container {
            background: var(--bg-surface); border-bottom: 1px solid var(--border-color);
            display: flex; justify-content: center; padding: 0 20px;
            flex-shrink: 0; position: sticky; top: 0; z-index: 15;
            box-shadow: 0 4px 6px -4px rgba(0,0,0,0.05);
        }
        .week-bar { 
            display: flex; gap: 10px; overflow-x: auto; 
            max-width: var(--container-width); width: 100%; padding: 15px 0;
            scrollbar-width: none; align-items: center;
        }
        .week-tab { 
            padding: 8px 20px; background: transparent; border-radius: 50px; 
            cursor: pointer; font-size: 0.9rem; font-weight: 500; color: var(--text-muted); 
            border: 1px solid transparent; white-space: nowrap; transition: 0.2s; flex-shrink: 0;
        }
        .week-tab:hover { background: #f8fafc; color: var(--primary); }
        .week-tab.active { 
            background: var(--primary-soft); color: var(--primary-dark); 
            font-weight: 700; border-color: var(--primary-soft);
        }
        
        /* Área do Formulário */
        .content-scroll { flex: 1; padding: 40px 20px; display: flex; justify-content: center; }
        .form-container { width: 100%; max-width: 900px; padding-bottom: 100px; animation: fadeIn 0.4s ease; }
        @keyframes fadeIn { from {opacity:0; transform:translateY(10px);} to {opacity:1; transform:translateY(0);} }

        /* Inputs */
        .week-title-editor { width: 100%; font-size: 1.8rem; font-weight: 700; border: none; background: transparent; text-align: center; margin-bottom: 40px; color: var(--text-main); font-family: 'Inter', sans-serif;}
        .section-card { background: var(--bg-surface); border-radius: var(--radius); padding: 35px; margin-bottom: 30px; box-shadow: var(--shadow-sm); border: 1px solid var(--border-color); }
        .section-title { color: var(--primary-dark); font-weight: 700; margin-bottom: 25px; text-transform: uppercase; font-size: 0.85rem; letter-spacing: 1px; display: flex; align-items: center; gap: 15px; }
        .section-title::after { content: ""; flex: 1; height: 1px; background: var(--border-color); }
        
        .form-group { margin-bottom: 25px; }
        label { display: block; font-size: 0.95rem; font-weight: 600; color: var(--text-main); margin-bottom: 10px; }
        
        input[type="text"], textarea, input[type="number"], input[type="time"] { 
            width: 100%; padding: 14px; border: 1px solid var(--border-color); 
            border-radius: 10px; background: #f8fafc; font-size: 1rem; color: var(--text-main); 
            font-family: 'Inter', sans-serif; transition: 0.2s; -webkit-appearance: none;
        }
        input:focus, textarea:focus { background: white; border-color: var(--primary); box-shadow: 0 0 0 3px var(--primary-soft); }

        .grid-2 { display: grid; grid-template-columns: 1fr 1fr; gap: 25px; }
        .checkbox-group { display: flex; gap: 20px; flex-wrap: wrap; background: #f8fafc; padding: 20px; border-radius: 10px; border: 1px solid var(--border-color); }
        .checkbox-item { display: flex; align-items: center; gap: 8px; font-size: 0.95rem; cursor: pointer; }
        input[type="checkbox"] { width: 18px; height: 18px; accent-color: var(--primary); cursor: pointer; }

        /* Footer */
        footer { background: var(--bg-surface); padding: 15px 20px; border-top: 1px solid var(--border-color); display: flex; justify-content: center; flex-shrink: 0; padding-bottom: env(safe-area-inset-bottom); }
        .footer-content { width: 100%; max-width: 1200px; display: flex; justify-content: flex-end; gap: 15px; }

        /* Botões */
        .btn { background: var(--primary); color: white; border: none; padding: 12px 24px; border-radius: 50px; cursor: pointer; font-weight: 600; font-size: 0.95rem; box-shadow: var(--shadow-sm); display: inline-flex; align-items: center; gap: 8px; }
        .btn-outline { background: white; border: 1px solid var(--border-color); color: var(--text-main); padding: 8px 16px; border-radius: 8px; cursor: pointer; font-weight: 500; display: inline-flex; align-items: center; gap: 6px; }
        .btn-ghost { background: transparent; border: none; cursor: pointer; color: var(--text-muted); padding: 8px 12px; font-size: 0.95rem; }
        .btn-danger { background: #fee2e2; color: #ef4444; border: none; padding: 8px 12px; border-radius: 8px; cursor: pointer; }

        /* Agenda & Ponto */
        .toggle-view-btn { background: #f1f5f9; color: var(--text-muted); padding: 8px 16px; border-radius: 50px; font-size: 0.9rem; font-weight: 600; cursor: pointer; border: 1px solid transparent; display:flex; gap:8px; align-items:center; }
        .toggle-view-btn.active { background: var(--text-main); color: white; }
        .agenda-nav { display: flex; justify-content: center; align-items: center; gap: 20px; margin-bottom: 30px; background: white; padding: 10px; border-radius: 50px; border: 1px solid var(--border-color); max-width: 500px; margin: 0 auto; box-shadow: var(--shadow-sm); }
        
        .metrics-container { display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 15px; margin-bottom: 30px; }
        .metric-box { background: white; padding: 20px; border-radius: 12px; border: 1px solid var(--border-color); text-align: center; box-shadow: var(--shadow-sm); }
        
        .timesheet-table { width: 100%; border-collapse: separate; border-spacing: 0 10px; }
        .ts-row { background: white; box-shadow: var(--shadow-sm); border-radius: 12px; }
        .ts-row td { padding: 15px; vertical-align: middle; border-top: 1px solid var(--border-color); border-bottom: 1px solid var(--border-color); }
        .ts-row td:first-child { border-left: 1px solid var(--border-color); border-radius: 12px 0 0 12px; }
        .ts-row td:last-child { border-right: 1px solid var(--border-color); border-radius: 0 12px 12px 0; }
        .ts-input { text-align: center; width: 100%; border: 1px solid var(--border-color); padding: 8px; border-radius: 6px; }

        /* Modal */
        #modal-overlay { display: none; position: fixed; inset: 0; background: rgba(0,0,0,0.4); backdrop-filter: blur(4px); z-index: 3000; justify-content: center; align-items: center; }
        .modal-card { background: white; width: 90%; max-width: 600px; max-height: 85vh; border-radius: 20px; display: flex; flex-direction: column; box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.1); }
        .modal-body { flex: 1; overflow-y: auto; padding: 25px; background: #f8fafc; }
        .meeting-item { background: white; padding: 20px; border-radius: 12px; border: 1px solid var(--border-color); margin-bottom: 15px; box-shadow: var(--shadow-sm); }

        /* --- RESPONSIVIDADE MOBILE/TABLET --- */
        @media (max-width: 1024px) {
            .login-box { width: 85%; padding: 2rem; }
            .week-bar { padding: 10px 0; } /* Ajuste fino mobile */
            .section-card { padding: 25px; }
            .grid-2 { grid-template-columns: 1fr; }
            
            /* Tabela vira Card no Mobile */
            .timesheet-table thead { display: none; }
            .timesheet-table, tbody, tr, td { display: block; width: 100%; }
            .ts-row { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; padding: 15px; height: auto; margin-bottom: 15px; }
            .ts-row td { border: none !important; padding: 0 !important; text-align: left !important; }
            .ts-row td:first-child { grid-column: 1 / -1; margin-bottom: 5px; font-weight: 700; border-bottom: 1px solid #f1f5f9 !important; padding-bottom: 5px !important; }
            .ts-row td:nth-child(2) { grid-column: 1 / -1; margin-bottom: 5px; }
            .ts-row td:last-child { grid-column: 1 / -1; text-align: right !important; background: #f8fafc; padding: 10px !important; border-radius: 8px !important; margin-top: 5px; }
            .ts-row.holiday td.merged-cell { grid-column: 1 / -1; }
        }
    </style>
</head>
<body>

    <div id="login-screen">
        <div class="login-box">
            <div style="font-size: 3rem; color: var(--primary); margin-bottom: 10px;"><i class="fas fa-fingerprint"></i></div>
            <h2 style="color:var(--text-main); margin-top:0; font-weight: 700;">Acesso Seguro</h2>
            <p style="color:var(--text-muted); font-size:0.95rem; margin-bottom:25px;">Seus dados ficam salvos apenas neste dispositivo.</p>
            <input type="password" id="password-input" class="login-input" placeholder="Digite sua senha">
            <button class="btn" onclick="checkPassword()" style="width:100%; justify-content: center; padding: 16px;">Entrar</button>
        </div>
    </div>

    <div id="app-container" style="display:none; flex-direction: column; height: 100%;">
        
        <header>
            <div class="header-content">
                <div id="header-dashboard">
                    <div class="brand-logo">
                        <i class="fas fa-shapes" style="color:var(--primary)"></i> Gestão Psi
                    </div>
                    
                    <div style="display:flex; background:#f1f5f9; padding:4px; border-radius:50px;">
                        <button id="btn-view-schools" class="toggle-view-btn active" onclick="switchMainView('schools')"><i class="fas fa-book"></i> <span style="margin-left:5px">Diários</span></button>
                        <button id="btn-view-agenda" class="toggle-view-btn" onclick="switchMainView('agenda')"><i class="far fa-clock"></i> <span style="margin-left:5px">Ponto</span></button>
                    </div>
                </div>

                <div id="header-school">
                    <button class="btn-outline" onclick="showDashboard()" title="Voltar">
                        <i class="fas fa-arrow-left"></i> Voltar
                    </button>
                    
                    <h2 id="current-school-name">Nome da Escola</h2>
                    
                    <div style="display:flex; gap:8px;">
                        <button class="btn-outline" onclick="openMeetings()"><i class="fas fa-users-cog"></i></button>
                        <button class="btn-danger" onclick="deleteSchool()"><i class="fas fa-trash-alt"></i></button>
                    </div>
                </div>
            </div>
        </header>

        <div id="app-content">
            
            <div id="dashboard-view">
                <div class="container-center">
                    <div class="section-header">
                        <h2>Minhas Escolas</h2>
                        <p style="color:var(--text-muted)">Gerencie seus diários de campo</p>
                    </div>
                    
                    <div class="school-grid" id="school-grid"></div>

                    <div style="text-align: center; margin-top: 50px;">
                        <button class="btn" onclick="addNewSchool()"><i class="fas fa-plus"></i> Nova Unidade</button>
                    </div>
                </div>
            </div>

            <div id="agenda-view" style="display:none;">
                <div class="container-center">
                    <div class="section-header" style="margin-bottom:20px;">
                        <h2>Controle de Ponto</h2>
                    </div>

                    <div class="agenda-nav">
                        <button class="btn-ghost" onclick="changeWeek(-1)"><i class="fas fa-chevron-left"></i></button>
                        <div id="agenda-current-week-display" style="font-weight: 700; min-width: 140px; text-align: center;">Semana Atual</div>
                        <button class="btn-ghost" onclick="changeWeek(1)"><i class="fas fa-chevron-right"></i></button>
                    </div>

                    <div class="metrics-container">
                        <div class="metric-box">
                            <div class="metric-val" style="color:var(--primary); font-size:1.5rem; font-weight:700;" id="metric-done">00h 00m</div>
                            <div class="metric-lbl" style="font-size:0.8rem; color:var(--text-muted); margin-top:5px;">REALIZADO</div>
                        </div>
                        <div class="metric-box">
                            <div class="metric-val" style="color:var(--text-muted); font-size:1.5rem; font-weight:700;" id="metric-left">30h 00m</div>
                            <div class="metric-lbl" style="font-size:0.8rem; color:var(--text-muted); margin-top:5px;">META (30h)</div>
                        </div>
                        <div class="metric-box">
                            <div class="metric-val" id="metric-balance" style="font-size:1.5rem; font-weight:700;">00h 00m</div>
                            <div class="metric-lbl" style="font-size:0.8rem; color:var(--text-muted); margin-top:5px;">SALDO</div>
                        </div>
                    </div>

                    <div class="section-card">
                        <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:20px; flex-wrap:wrap; gap:10px;">
                            <h3 style="margin:0;">Registros</h3>
                            <button class="btn-outline" onclick="copyPreviousWeek()" style="font-size:0.85rem;"><i class="fas fa-copy"></i> Copiar Anterior</button>
                        </div>
                        <table class="timesheet-table">
                            <thead>
                                <tr style="text-align:left; color:var(--text-muted); font-size:0.85rem;">
                                    <th style="padding-left:15px">Dia</th>
                                    <th>Local</th>
                                    <th style="text-align:center;">Entrada</th>
                                    <th style="text-align:center;">Saída</th>
                                    <th style="text-align:center;">Pausa</th>
                                    <th style="text-align:right; padding-right:15px">Total</th>
                                </tr>
                            </thead>
                            <tbody id="agenda-body"></tbody>
                        </table>
                    </div>
                </div>
            </div>

            <div id="school-view">
                <div class="week-bar-container">
                    <div class="week-bar">
                        <div id="week-tabs" style="display:flex; gap:10px;"></div>
                        <button class="week-tab" style="color:var(--primary); background: rgba(13, 148, 136, 0.1);" onclick="addWeek()">+ Semana</button>
                    </div>
                </div>
                
                <div class="content-scroll">
                    <div class="form-container">
                        <input type="text" id="week-title-edit" class="week-title-editor" onchange="updateWeekName(this.value)">
                        <div id="form-container-inner"></div>
                        <div style="margin-top:60px; text-align:center; padding-top:30px; border-top:2px dashed var(--border-color);">
                            <button class="btn-outline" onclick="addGenericTopic()" style="border-style: dashed;">+ Tópico Livre</button>
                        </div>
                    </div>
                </div>
            </div>

        </div>

        <footer>
            <div class="footer-content">
                <input type="file" id="import-file" hidden onchange="importData(this)">
                <button class="btn-ghost" onclick="document.getElementById('import-file').click()"><i class="fas fa-file-upload"></i> Restaurar</button>
                <button class="btn-ghost" onclick="exportData()"><i class="fas fa-download"></i> Backup</button>
            </div>
        </footer>

    </div>

    <div id="modal-overlay">
        <div class="modal-card">
            <div class="modal-header" style="padding: 20px; border-bottom: 1px solid #e2e8f0; display:flex; justify-content:space-between;">
                <h3 style="margin:0; font-size: 1.1rem;">Reuniões</h3>
                <button class="btn-ghost" onclick="closeMeetings()"><i class="fas fa-times"></i></button>
            </div>
            <div class="modal-body">
                <div style="text-align:center; margin-bottom:20px;">
                    <button class="btn" onclick="addMeeting()" style="width:100%"><i class="fas fa-plus"></i> Nova Reunião</button>
                </div>
                <div id="meetings-list"></div>
            </div>
        </div>
    </div>

    <script>
        // ==========================================
        // LÓGICA DO SISTEMA (COMPLETA E RESTAURADA)
        // ==========================================

        document.getElementById('password-input').addEventListener('keypress', (e) => {
            if(e.key === 'Enter') checkPassword();
        });

        // ---------------- MODELOS COMPLETOS (NÃO APAGAR) ----------------

        // SEMANA 1: Identificação, Infraestrutura, Demandas
        const modeloSemana1 = { 
            type: 's1', 
            data: { 
                // Seção 1: Identificação
                nome: '', endereco: '', 
                niveis: {infantil:false, fund1:false, fund2:false, medio:false, eja:false}, 
                alunos: '', turmas: '', 
                turnos: {mat:false, vesp:false, not:false, int:false}, 
                diretor: '', coord: '', orientador: '', 
                // Seção 2: Infraestrutura
                condicoes: '', espacos: '', recursos: '', acessibilidade: '', sala_psi: '', 
                // Seção 6: Demandas
                queixa_gestao: '', queixa_profs: '', encaminhamentos: '' 
            }
        };

        // SEMANA 2: Organização, Clima
        const modeloSemana2 = { 
            type: 's2', 
            data: { 
                // Seção 3: Organização
                horarios: '', regras: '', comunicacao: '', conselhos: '', 
                // Seção 5: Clima
                rel_gp: '', rel_pa: '', rel_pp: '', rel_ef: '' 
            }
        };

        // SEMANA 3: Pedagógico, Síntese
        const modeloSemana3 = { 
            type: 's3', 
            data: { 
                // Seção 4: Pedagógico
                ppp: '', indices: '', inclusao: '', 
                // Síntese
                sintese: '', plano: '' 
            }
        };

        const genericTemplate = [ { title: 'Diário de Campo', content: '' } ];
        const baseDay = (dayName) => ({ day: dayName, local: '', in: '', out: '', pause: 0, isHoliday: false, credit: '' });
        const daysOfWeek = ['Seg','Ter','Qua','Qui','Sex'];

        function getInitialData() {
            const clone = (obj) => JSON.parse(JSON.stringify(obj));
            return {
                security: { hash: null },
                schools: [
                    { 
                        id: 1, name: "Escola Exemplo", desc: "Terça e Quinta", meetings: [],
                        weeks: [ 
                            { id: 1, name: "Semana 1 - Diagnóstico", content: clone(modeloSemana1), extra: [] },
                            { id: 2, name: "Semana 2 - Clima", content: clone(modeloSemana2), extra: [] }
                        ] 
                    }
                ],
                calendar: {}
            };
        }

        let appData = getInitialData();
        let currSchool = null;
        let currWeek = null;
        let currentAgendaOffset = 0; 

        // --- Criptografia e Auth ---
        async function sha256(str) {
            const buf = await crypto.subtle.digest("SHA-256", new TextEncoder().encode(str));
            return Array.from(new Uint8Array(buf)).map(b => b.toString(16).padStart(2, "0")).join("");
        }

        async function checkPassword() {
            const input = document.getElementById('password-input').value;
            const saved = localStorage.getItem('psicoGestao_v9');
            
            if(saved) {
                const parsed = JSON.parse(saved);
                if(!parsed.calendar && parsed.agenda) {
                    const k = getWeekKey(0); parsed.calendar = {}; parsed.calendar[k] = parsed.agenda; delete parsed.agenda;
                } else if (!parsed.calendar) { parsed.calendar = {}; }
                
                if(parsed.security && parsed.security.hash) {
                    if(await sha256(input) === parsed.security.hash) { appData = parsed; enterApp(); } else alert("Senha incorreta.");
                } else setupPass(input);
            } else setupPass(input);
        }

        async function setupPass(pass) {
            if(pass.length < 4) return alert("Senha muito curta (min 4).");
            appData = getInitialData(); appData.security.hash = await sha256(pass); save(); enterApp();
        }

        function enterApp() {
            document.getElementById('login-screen').style.display = 'none';
            document.getElementById('app-container').style.display = 'flex';
            renderDashboard();
        }

        function save() { localStorage.setItem('psicoGestao_v9', JSON.stringify(appData)); }

        // --- Navegação ---
        function switchMainView(view) {
            const dash = document.getElementById('dashboard-view');
            const agenda = document.getElementById('agenda-view');
            const btnS = document.getElementById('btn-view-schools');
            const btnA = document.getElementById('btn-view-agenda');

            if(view === 'schools') {
                dash.style.display = 'block'; agenda.style.display = 'none';
                btnS.classList.add('active'); btnA.classList.remove('active');
                renderDashboard();
            } else {
                dash.style.display = 'none'; agenda.style.display = 'block';
                btnS.classList.remove('active'); btnA.classList.add('active');
                currentAgendaOffset = 0; renderAgenda();
            }
        }

        // --- DASHBOARD ---
        function renderDashboard() {
            document.getElementById('school-view').style.display = 'none';
            document.getElementById('header-dashboard').style.display = 'flex';
            document.getElementById('header-school').style.display = 'none';
            const grid = document.getElementById('school-grid'); grid.innerHTML = '';
            appData.schools.forEach((s, idx) => {
                const div = document.createElement('div'); div.className = 'school-card'; div.onclick = () => openSchool(idx);
                div.innerHTML = `<div><div style="display:flex; justify-content:space-between; align-items:start"><h3 style="color:var(--text-main); margin:0;">${s.name}</h3><i class="fas fa-school" style="color:var(--primary-soft); background: var(--primary); padding:8px; border-radius:50%; font-size: 0.8rem;"></i></div><p style="margin-top:5px; font-size:0.9rem; color:var(--text-muted);">${s.desc}</p></div><div style="font-size:0.85rem; color:var(--text-muted); margin-top:15px; border-top:1px solid var(--border-color); padding-top:10px; display:flex; justify-content:space-between;"><span>${s.weeks.length} semanas</span><span><i class="fas fa-chevron-right"></i></span></div>`;
                grid.appendChild(div);
            });
        }

        function addNewSchool() {
            const name = prompt("Nome da Escola:");
            if(name) {
                const desc = prompt("Descrição (Ex: Segunda e Terça):");
                const clone = (obj) => JSON.parse(JSON.stringify(obj));
                const newSchool = { id: Date.now(), name, desc, meetings: [], weeks: [ { id: Date.now()+1, name: "S1 - Identificação", content: clone(modeloSemana1), extra: [] }, { id: Date.now()+2, name: "S2 - Clima", content: clone(modeloSemana2), extra: [] }, { id: Date.now()+3, name: "S3 - Pedagógico", content: clone(modeloSemana3), extra: [] } ] };
                appData.schools.push(newSchool); save(); renderDashboard();
            }
        }
        function deleteSchool() { if(confirm("Apagar escola?")) { appData.schools.splice(currSchool, 1); save(); showDashboard(); } }
        function showDashboard() { currSchool = null; switchMainView('schools'); }

        // --- AGENDA & PONTO ---
        function getWeekKey(offset) {
            const d = new Date(); const day = d.getDay(); const diff = d.getDate() - day + (day == 0 ? -6 : 1);
            const monday = new Date(d.setDate(diff)); monday.setDate(monday.getDate() + (offset * 7));
            return monday.toISOString().split('T')[0];
        }
        function getWeekLabel(offset) {
            const d = new Date(); const day = d.getDay(); const diff = d.getDate() - day + (day == 0 ? -6 : 1);
            const monday = new Date(d.setDate(diff)); monday.setDate(monday.getDate() + (offset * 7));
            const friday = new Date(monday); friday.setDate(friday.getDate() + 4);
            const fmt = (date) => `${String(date.getDate()).padStart(2,'0')}/${String(date.getMonth()+1).padStart(2,'0')}`;
            return `${fmt(monday)} a ${fmt(friday)}`;
        }

        function renderAgenda() {
            const weekKey = getWeekKey(currentAgendaOffset);
            if(!appData.calendar[weekKey]) appData.calendar[weekKey] = daysOfWeek.map(d => baseDay(d));
            const currentData = appData.calendar[weekKey];
            const tbody = document.getElementById('agenda-body'); tbody.innerHTML = '';
            let totalMins = 0;

            document.getElementById('agenda-current-week-display').innerText = getWeekLabel(currentAgendaOffset);

            currentData.forEach((day, idx) => {
                let mins = 0;
                let inputsHTML = '';
                const rowClass = day.isHoliday ? 'ts-row holiday' : 'ts-row';

                if(day.isHoliday) {
                    if(day.credit) {
                        const [h, m] = day.credit.split(':').map(Number);
                        mins = (h*60) + m;
                    }
                    inputsHTML = `
                        <td colspan="3" class="merged-cell" style="text-align:center; padding: 10px;">
                            <div style="display:flex; justify-content:center; align-items:center; gap:10px;">
                                <span style="font-weight:700; color:var(--primary); font-size:0.9rem;">ABONO:</span>
                                <input type="time" class="ts-input" value="${day.credit}" onchange="upAg('${weekKey}',${idx},'credit',this.value)" style="max-width:120px; background:white;">
                            </div>
                        </td>
                    `;
                } else {
                    if(day.in && day.out) {
                        const [h1, m1] = day.in.split(':').map(Number);
                        const [h2, m2] = day.out.split(':').map(Number);
                        let diff = (h2*60 + m2) - (h1*60 + m1);
                        if(day.pause) diff -= parseInt(day.pause);
                        if(diff > 0) mins = diff;
                    }
                    inputsHTML = `
                        <td style="text-align:center"><input type="time" class="ts-input" value="${day.in}" onchange="upAg('${weekKey}',${idx},'in',this.value)"></td>
                        <td style="text-align:center"><input type="time" class="ts-input" value="${day.out}" onchange="upAg('${weekKey}',${idx},'out',this.value)"></td>
                        <td style="text-align:center"><input type="number" class="ts-input" placeholder="0" value="${day.pause}" onchange="upAg('${weekKey}',${idx},'pause',this.value)" style="width:70px"></td>
                    `;
                }
                
                totalMins += mins;
                const h = Math.floor(mins/60); const m = mins%60; const txt = `${h}h ${m.toString().padStart(2,'0')}m`;

                tbody.innerHTML += `
                <tr class="${rowClass}">
                    <td>
                        <div style="display:flex; align-items:center; justify-content:space-between;">
                            ${day.day}
                            <button class="btn-holiday ${day.isHoliday?'active':''}" onclick="toggleHoliday('${weekKey}',${idx})"><i class="fas fa-umbrella-beach"></i></button>
                        </div>
                    </td>
                    <td><input type="text" class="ts-input ts-input-local" placeholder="Local" value="${day.local}" onchange="upAg('${weekKey}',${idx},'local',this.value)"></td>
                    ${inputsHTML}
                    <td style="font-weight:700; color:var(--primary); text-align:right;">${txt}</td>
                </tr>`;
            });

            const target = 30 * 60; const left = target - totalMins;
            const fmt = (m) => `${Math.floor(Math.abs(m)/60)}h ${Math.abs(m)%60}m`;
            document.getElementById('metric-done').innerText = fmt(totalMins);
            document.getElementById('metric-left').innerText = left > 0 ? fmt(left) : '0h 0m';
            const bal = document.getElementById('metric-balance');
            if(left > 0) { bal.innerText = "-" + fmt(left); bal.style.color = "#ef4444"; } else { bal.innerText = "+" + fmt(left); bal.style.color = "#0d9488"; }
        }

        function toggleHoliday(key, idx) {
            appData.calendar[key][idx].isHoliday = !appData.calendar[key][idx].isHoliday;
            if(appData.calendar[key][idx].isHoliday) { appData.calendar[key][idx].in = ''; appData.calendar[key][idx].out = ''; appData.calendar[key][idx].pause = 0; }
            save(); renderAgenda();
        }

        function changeWeek(dir) { currentAgendaOffset += dir; renderAgenda(); }
        function upAg(key, idx, field, val) { appData.calendar[key][idx][field] = val; save(); renderAgenda(); }

        function copyPreviousWeek() {
            const currentKey = getWeekKey(currentAgendaOffset);
            const prevKey = getWeekKey(currentAgendaOffset - 1);
            if(!appData.calendar[prevKey]) return alert("Sem dados anteriores.");
            if(confirm("Copiar semana anterior?")) {
                const prevData = JSON.parse(JSON.stringify(appData.calendar[prevKey]));
                const cleanData = prevData.map(d => ({...d, isHoliday: false, credit: ''}));
                appData.calendar[currentKey] = cleanData;
                save(); renderAgenda();
            }
        }

        // --- ESCOLA VIEW ---
        function openSchool(idx) {
            currSchool = idx; currWeek = 0;
            document.getElementById('dashboard-view').style.display = 'none'; document.getElementById('agenda-view').style.display = 'none';
            document.getElementById('school-view').style.display = 'flex'; document.getElementById('header-dashboard').style.display = 'none';
            document.getElementById('header-school').style.display = 'flex';
            document.getElementById('current-school-name').innerText = appData.schools[idx].name; renderWeeks();
        }

        function renderWeeks() {
            const container = document.getElementById('week-tabs'); container.innerHTML = '';
            appData.schools[currSchool].weeks.forEach((w, idx) => {
                const btn = document.createElement('button'); let shortName = w.name; if(w.name.includes("-")) shortName = w.name.split("-")[0];
                btn.className = `week-tab ${idx === currWeek ? 'active' : ''}`; btn.innerText = shortName; btn.onclick = () => { currWeek = idx; renderWeeks(); };
                container.appendChild(btn);
            }); renderForm();
        }

        function addWeek() {
            const num = appData.schools[currSchool].weeks.length + 1; const newTopics = JSON.parse(JSON.stringify(genericTemplate));
            appData.schools[currSchool].weeks.push({ id: Date.now(), name: `Semana ${num}`, content: { type: 'generic', data: {} }, extra: newTopics });
            currWeek = appData.schools[currSchool].weeks.length - 1; save(); renderWeeks();
        }
        function updateWeekName(val) { appData.schools[currSchool].weeks[currWeek].name = val; save(); renderWeeks(); }

        function renderForm() {
            const week = appData.schools[currSchool].weeks[currWeek]; document.getElementById('week-title-edit').value = week.name;
            const container = document.getElementById('form-container-inner'); container.innerHTML = '';
            if(week.content.type === 's1') formS1(week.content.data, container); else if(week.content.type === 's2') formS2(week.content.data, container); else if(week.content.type === 's3') formS3(week.content.data, container);
            if(!week.extra) week.extra = []; week.extra.forEach((t, idx) => formGeneric(t, idx, container));
        }

        // --- FORMULÁRIOS COMPLETOS RESTAURADOS ---

        // SEMANA 1: Itens 1, 2 e 6
        function formS1(d, c) {
            c.innerHTML += `
            <div class="section-card">
                <div class="section-title">1. Identificação e Dados Gerais</div>
                <div class="form-group"><label>Nome da Escola</label><input type="text" value="${d.nome}" oninput="upD('nome', this.value)"></div>
                <div class="form-group"><label>Endereço/Bairro</label><input type="text" value="${d.endereco}" oninput="upD('endereco', this.value)"></div>
                <div class="form-group"><label>Níveis de Ensino</label><div class="checkbox-group">
                    <label class="checkbox-item"><input type="checkbox" ${d.niveis.infantil?'checked':''} onchange="upC('niveis','infantil',this.checked)">Ed. Infantil</label>
                    <label class="checkbox-item"><input type="checkbox" ${d.niveis.fund1?'checked':''} onchange="upC('niveis','fund1',this.checked)">Fund. I</label>
                    <label class="checkbox-item"><input type="checkbox" ${d.niveis.fund2?'checked':''} onchange="upC('niveis','fund2',this.checked)">Fund. II</label>
                    <label class="checkbox-item"><input type="checkbox" ${d.niveis.medio?'checked':''} onchange="upC('niveis','medio',this.checked)">Médio</label>
                    <label class="checkbox-item"><input type="checkbox" ${d.niveis.eja?'checked':''} onchange="upC('niveis','eja',this.checked)">EJA</label>
                </div></div>
                <div class="grid-2">
                    <div class="form-group"><label>Número de Alunos</label><input type="text" value="${d.alunos}" oninput="upD('alunos',this.value)"></div>
                    <div class="form-group"><label>Número de Turmas</label><input type="text" value="${d.turmas}" oninput="upD('turmas',this.value)"></div>
                </div>
                <div class="form-group"><label>Turnos de Funcionamento</label><div class="checkbox-group">
                    <label class="checkbox-item"><input type="checkbox" ${d.turnos.mat?'checked':''} onchange="upC('turnos','mat',this.checked)">Matutino</label>
                    <label class="checkbox-item"><input type="checkbox" ${d.turnos.vesp?'checked':''} onchange="upC('turnos','vesp',this.checked)">Vespertino</label>
                    <label class="checkbox-item"><input type="checkbox" ${d.turnos.not?'checked':''} onchange="upC('turnos','not',this.checked)">Noturno</label>
                    <label class="checkbox-item"><input type="checkbox" ${d.turnos.int?'checked':''} onchange="upC('turnos','int',this.checked)">Integral</label>
                </div></div>
                <div class="form-group"><label>Equipe Gestora</label>
                    <div style="display:flex; flex-direction:column; gap:10px;">
                        <input type="text" placeholder="Diretor(a)" value="${d.diretor}" oninput="upD('diretor',this.value)">
                        <input type="text" placeholder="Coord. Pedagógico(a)" value="${d.coord}" oninput="upD('coord',this.value)">
                        <input type="text" placeholder="Orientador(a) Educacional" value="${d.orientador}" oninput="upD('orientador',this.value)">
                    </div>
                </div>
            </div>
            
            <div class="section-card">
                <div class="section-title">2. Infraestrutura e Ambiente Físico</div>
                <div class="form-group"><label>Condições Gerais</label><textarea rows="3" placeholder="Limpeza, iluminação, ventilação, conservação..." oninput="upD('condicoes',this.value)">${d.condicoes}</textarea></div>
                <div class="form-group"><label>Espaços de Convivência</label><textarea rows="3" placeholder="Pátio, quadra, biblioteca, refeitório... como são usados?" oninput="upD('espacos',this.value)">${d.espacos}</textarea></div>
                <div class="form-group"><label>Recursos Pedagógicos</label><textarea rows="3" placeholder="Sala de recursos, laboratórios, biblioteca, internet..." oninput="upD('recursos',this.value)">${d.recursos}</textarea></div>
                <div class="form-group"><label>Acessibilidade</label><textarea rows="3" placeholder="Escola adaptada para deficientes físicos?" oninput="upD('acessibilidade',this.value)">${d.acessibilidade}</textarea></div>
                <div class="form-group"><label>Sala da Psicologia/Atendimento</label><textarea rows="3" placeholder="Existe espaço reservado para escuta sigilosa?" oninput="upD('sala_psi',this.value)">${d.sala_psi}</textarea></div>
            </div>

            <div class="section-card">
                <div class="section-title">6. Levantamento de Demandas e Queixas</div>
                <div class="form-group"><label>Queixa Principal da Gestão</label><textarea rows="3" placeholder="O que esperam do psicólogo?" oninput="upD('queixa_gestao',this.value)">${d.queixa_gestao}</textarea></div>
                <div class="form-group"><label>Queixa Principal dos Professores</label><textarea rows="3" placeholder="Dificuldades de aprendizagem, indisciplina, desmotivação..." oninput="upD('queixa_profs',this.value)">${d.queixa_profs}</textarea></div>
                <div class="form-group"><label>Principais Encaminhamentos</label><textarea rows="3" placeholder="Conselho Tutelar, CRAS, Saúde?" oninput="upD('encaminhamentos',this.value)">${d.encaminhamentos}</textarea></div>
            </div>`;
        }

        // SEMANA 2: Itens 3 e 5
        function formS2(d, c) {
            c.innerHTML += `
            <div class="section-card">
                <div class="section-title">3. Organização e Rotina Escolar</div>
                <div class="form-group"><label>Horários Críticos</label><textarea rows="3" placeholder="Entrada, saída, recreio. Onde há desorganização?" oninput="upD('horarios',this.value)">${d.horarios}</textarea></div>
                <div class="form-group"><label>Regras e Normas</label><textarea rows="3" placeholder="Regimento claro? Construído coletivamente?" oninput="upD('regras',this.value)">${d.regras}</textarea></div>
                <div class="form-group"><label>Comunicação</label><textarea rows="3" placeholder="Entre direção/professores e com pais?" oninput="upD('comunicacao',this.value)">${d.comunicacao}</textarea></div>
                <div class="form-group"><label>Conselhos de Classe</label><textarea rows="3" placeholder="Focam apenas em notas/comportamento?" oninput="upD('conselhos',this.value)">${d.conselhos}</textarea></div>
            </div>
            
            <div class="section-card">
                <div class="section-title">5. Clima Escolar e Relações Interpessoais</div>
                <div class="grid-2">
                    <div class="form-group"><label>Relação Gestão-Professores</label><textarea rows="3" placeholder="Democrática, autoritária, parceira?" oninput="upD('rel_gp',this.value)">${d.rel_gp}</textarea></div>
                    <div class="form-group"><label>Relação Professor-Aluno</label><textarea rows="3" placeholder="Respeito, medo, afeto?" oninput="upD('rel_pa',this.value)">${d.rel_pa}</textarea></div>
                </div>
                <div class="form-group"><label>Relação entre Pares (Alunos)</label><textarea rows="3" placeholder="Grupos isolados? Bullying?" oninput="upD('rel_pp',this.value)">${d.rel_pp}</textarea></div>
                <div class="form-group"><label>Relação Escola-Família</label><textarea rows="3" placeholder="Pais participam?" oninput="upD('rel_ef',this.value)">${d.rel_ef}</textarea></div>
            </div>`;
        }

        // SEMANA 3: Item 4 e Síntese
        function formS3(d, c) {
            c.innerHTML += `
            <div class="section-card">
                <div class="section-title">4. Aspectos Pedagógicos e Documentais</div>
                <div class="form-group"><label>Projeto Político-Pedagógico (PPP)</label><textarea rows="3" placeholder="Existe? Atualizado? Prática condiz com documento?" oninput="upD('ppp',this.value)">${d.ppp}</textarea></div>
                <div class="form-group"><label>Índices de Desempenho</label><textarea rows="3" placeholder="Aprovação, reprovação, evasão." oninput="upD('indices',this.value)">${d.indices}</textarea></div>
                <div class="form-group"><label>Inclusão Escolar</label><textarea rows="3" placeholder="Quantos alunos? Quais deficiências? Relação professor-aluno?" oninput="upD('inclusao',this.value)">${d.inclusao}</textarea></div>
            </div>
            <div class="section-card">
                <div class="section-title">Síntese Diagnóstica</div>
                <div class="form-group"><label>Diagnóstico Preliminar</label><textarea rows="4" placeholder="Resumo das observações." oninput="upD('sintese',this.value)">${d.sintese}</textarea></div>
                <div class="form-group"><label>Plano de Ação</label><textarea rows="4" placeholder="Por onde começar?" oninput="upD('plano',this.value)">${d.plano}</textarea></div>
            </div>`;
        }

        function formGeneric(t, idx, c) { c.innerHTML += `<div class="section-card generic-topic" style="padding:0;"><div class="generic-header" style="background:#f1f5f9; padding:15px; border-bottom:1px solid var(--border-color); display:flex; justify-content:space-between;"><input type="text" class="generic-title-input" style="font-size:1rem; padding:0; background:transparent; border:none; color:var(--primary-dark); font-weight:700;" value="${t.title}" onchange="upXT(${idx},this.value)"><button class="btn-danger" style="background:transparent; border:none; color:#ef4444;" onclick="delX(${idx})"><i class="fas fa-trash-alt"></i></button></div><div class="generic-body" style="padding:20px;"><textarea rows="4" oninput="upXC(${idx},this.value)" placeholder="Escreva aqui..." style="border:none; background:transparent; width:100%; outline:none;">${t.content}</textarea></div></div>`; }
        function upD(k, v) { appData.schools[currSchool].weeks[currWeek].content.data[k] = v; save(); }
        function upC(ok, k, v) { appData.schools[currSchool].weeks[currWeek].content.data[ok][k] = v; save(); }
        function upXT(i, v) { appData.schools[currSchool].weeks[currWeek].extra[i].title = v; save(); }
        function upXC(i, v) { appData.schools[currSchool].weeks[currWeek].extra[i].content = v; save(); }
        function addGenericTopic() { appData.schools[currSchool].weeks[currWeek].extra.push({title:'Nota', content:''}); save(); renderForm(); }
        function delX(i) { if(confirm("Apagar?")) { appData.schools[currSchool].weeks[currWeek].extra.splice(i,1); save(); renderForm(); }}

        function openMeetings() { document.getElementById('modal-overlay').style.display = 'flex'; renderMeetings(); }
        function closeMeetings() { document.getElementById('modal-overlay').style.display = 'none'; }
        function renderMeetings() { const list = document.getElementById('meetings-list'); list.innerHTML = ''; const meetings = appData.schools[currSchool].meetings || []; if(meetings.length===0) list.innerHTML='<div style="text-align:center;color:var(--text-muted); margin-top:20px;">Sem reuniões registradas.</div>'; meetings.forEach((m, i) => { list.innerHTML += `<div class="meeting-item"><div style="display:flex; justify-content:space-between; margin-bottom:10px;"><input type="date" value="${m.date}" onchange="upMeet(${i},'date',this.value)" style="border:none; font-weight:700; color:var(--primary); font-family:Inter, sans-serif;"><button class="btn-danger" style="padding:4px 8px;" onclick="delMeet(${i})"><i class="fas fa-trash"></i></button></div><textarea rows="3" placeholder="Pauta..." oninput="upMeet(${i},'text',this.value)" style="width:100%;">${m.text}</textarea></div>`; }); }
        function addMeeting() { if(!appData.schools[currSchool].meetings) appData.schools[currSchool].meetings=[]; appData.schools[currSchool].meetings.unshift({date:new Date().toISOString().slice(0,10),part:'',text:''}); save(); renderMeetings(); }
        function upMeet(i,k,v) { appData.schools[currSchool].meetings[i][k]=v; save(); }
        function delMeet(i) { if(confirm("Apagar?")) { appData.schools[currSchool].meetings.splice(i,1); save(); renderMeetings(); }}
        
        function exportData() { const dataStr = JSON.stringify(appData); const dataUri = 'data:application/json;charset=utf-8,'+ encodeURIComponent(dataStr); let link = document.createElement('a'); link.setAttribute('href', dataUri); link.setAttribute('download', 'Backup_PsiEscolar.json'); link.click(); }
        function importData(input) { const file = input.files[0]; if(!file) return; const reader = new FileReader(); reader.onload = (e) => { try { const d = JSON.parse(e.target.result); if(confirm("Substituir dados atuais?")) { appData=d; save(); location.reload(); } } catch(err) { alert("Arquivo inválido."); } }; reader.readAsText(file); }
    </script>
</body>
</html>