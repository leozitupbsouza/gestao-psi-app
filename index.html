<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, interactive-widget=resizes-content">
    <title>Gestão Psicologia Escolar</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>

    <style>
        /* --- ESTILOS GERAIS (Minimalismo & Design System) --- */
        :root {
            --primary: #0d9488;
            --primary-dark: #0f766e;
            --primary-soft: #ccfbf1;
            --bg-body: #f3f4f6;
            --bg-surface: #ffffff;
            --text-main: #1e293b;
            --text-muted: #64748b;
            --border-color: #e2e8f0;
            --shadow-sm: 0 1px 3px rgba(0,0,0,0.05);
            --shadow-md: 0 4px 6px -1px rgba(0,0,0,0.05), 0 2px 4px -1px rgba(0,0,0,0.03);
            --radius: 12px; 
            --container-width: 1000px;
            
            /* Status Colors para Alunos */
            --status-green: #22c55e;
            --status-orange: #f59e0b;
            --status-red: #ef4444;
            --tag-blue: #3b82f6;
            --tag-purple: #8b5cf6;
        }

        * { box-sizing: border-box; outline: none; -webkit-tap-highlight-color: transparent; }
        
        body { 
            background-color: var(--bg-body); 
            color: var(--text-main); 
            margin: 0; 
            height: 100dvh; 
            font-family: 'Inter', sans-serif;
            display: flex; 
            flex-direction: column; 
            overflow: hidden; 
        }

        /* Scrollbar Refinada */
        ::-webkit-scrollbar { width: 6px; height: 6px; }
        ::-webkit-scrollbar-track { background: transparent; }
        ::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 10px; }

        /* Login Screen */
        #login-screen { position: fixed; inset: 0; background: var(--bg-body); display: flex; justify-content: center; align-items: center; z-index: 2000; }
        .login-box { background: var(--bg-surface); padding: 3rem; border-radius: 24px; width: 90%; max-width: 400px; text-align: center; box-shadow: var(--shadow-md); border: 1px solid var(--border-color); }
        .login-input { width: 100%; padding: 18px; margin: 20px 0; border: 2px solid var(--border-color); border-radius: var(--radius); font-size: 16px; text-align: center; background: #f8fafc; }
        .login-input:focus { border-color: var(--primary); background: white; }
        
        /* Header */
        header { 
            background: var(--bg-surface); height: 70px; 
            border-bottom: 1px solid var(--border-color); 
            display: flex; justify-content: center; align-items: center; 
            flex-shrink: 0; z-index: 20; padding: 0 20px;
        }
        .header-content { width: 100%; max-width: 1200px; display: flex; justify-content: space-between; align-items: center; }
        
        #header-dashboard { width: 100%; display: flex; justify-content: space-between; align-items: center; }
        .brand-logo { font-size: 1.2rem; font-weight: 700; display: flex; align-items: center; gap: 10px; color: var(--text-main); }
        
        #header-school { display: none; width: 100%; justify-content: space-between; align-items: center; }
        #current-school-name { font-size: 1.2rem; font-weight: 700; margin: 0 15px; text-align: center; flex: 1; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }

        /* Conteúdo Principal */
        #app-content { flex: 1; overflow-y: auto; overflow-x: hidden; position: relative; scroll-behavior: smooth; }

        /* Dashboard (Grid de Escolas) */
        #dashboard-view { padding: 40px 20px; }
        .container-center { max-width: 1200px; margin: 0 auto; }
        .section-header { text-align: center; margin-bottom: 40px; }
        .section-header h2 { font-size: 1.8rem; margin: 0 0 8px 0; }
        .school-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(300px, 1fr)); gap: 20px; }
        .school-card { background: var(--bg-surface); padding: 25px; border-radius: var(--radius); border: 1px solid var(--border-color); cursor: pointer; transition: 0.2s; display: flex; flex-direction: column; justify-content: space-between; min-height: 160px; box-shadow: var(--shadow-sm); }
        .school-card:hover { transform: translateY(-2px); box-shadow: var(--shadow-md); border-color: var(--primary-soft); }

        /* Visão Escola (Abas e Formulários) */
        #school-view { display: none; flex-direction: column; height: 100%; }
        .week-bar-container { background: var(--bg-surface); border-bottom: 1px solid var(--border-color); display: flex; justify-content: center; padding: 0 20px; flex-shrink: 0; position: sticky; top: 0; z-index: 15; }
        .week-bar { display: flex; gap: 10px; overflow-x: auto; max-width: var(--container-width); width: 100%; padding: 15px 0; scrollbar-width: none; align-items: center; }
        
        .week-tab { padding: 8px 20px; background: transparent; border-radius: 50px; cursor: pointer; font-size: 0.9rem; font-weight: 500; color: var(--text-muted); border: 1px solid transparent; white-space: nowrap; transition: 0.2s; flex-shrink: 0; }
        .week-tab:hover { background: #f8fafc; color: var(--text-main); }
        .week-tab.active { background: var(--primary-soft); color: var(--primary-dark); font-weight: 700; border-color: var(--primary-soft); }
        
        .week-tab.tab-special { border: 1px dashed var(--border-color); margin-left: 5px; }
        .week-tab.tab-special.active { border-style: solid; background: #fff7ed; color: #c2410c; border-color: #ffedd5; }
        
        .week-tab.tab-special-2 { border: 1px dashed var(--border-color); margin-left: 5px; }
        .week-tab.tab-special-2.active { border-style: solid; background: #eff6ff; color: #1d4ed8; border-color: #dbeafe; }

        .content-scroll { flex: 1; padding: 40px 20px; display: flex; justify-content: center; }
        .form-container { width: 100%; max-width: 900px; padding-bottom: 100px; animation: fadeIn 0.4s ease; }
        @keyframes fadeIn { from {opacity:0; transform:translateY(10px);} to {opacity:1; transform:translateY(0);} }

        /* Inputs & Componentes de Formulário */
        .week-title-editor { width: 100%; font-size: 1.8rem; font-weight: 700; border: none; background: transparent; text-align: center; margin-bottom: 40px; color: var(--text-main); font-family: 'Inter', sans-serif;}
        .section-card { background: var(--bg-surface); border-radius: var(--radius); padding: 35px; margin-bottom: 30px; box-shadow: var(--shadow-sm); border: 1px solid var(--border-color); }
        
        .section-title { color: var(--primary-dark); font-weight: 700; margin-bottom: 25px; text-transform: uppercase; font-size: 0.85rem; letter-spacing: 1px; display: flex; align-items: center; gap: 15px; }
        .section-title::after { content: ""; flex: 1; height: 1px; background: var(--border-color); }
        
        .form-group { margin-bottom: 25px; }
        label { display: block; font-size: 0.95rem; font-weight: 600; color: var(--text-main); margin-bottom: 10px; }
        
        /* Estilização Unificada de Inputs */
        input[type="text"], textarea, input[type="number"], input[type="time"], input[type="date"], select { 
            width: 100%; padding: 14px; border: 1px solid var(--border-color); border-radius: 10px; 
            background: #f8fafc; font-size: 1rem; color: var(--text-main); font-family: 'Inter', sans-serif; 
            transition: 0.2s; -webkit-appearance: none; box-sizing: border-box;
        }
        select { background-image: url("data:image/svg+xml;charset=UTF-8,%3csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24' fill='none' stroke='%2364748b' stroke-width='2' stroke-linecap='round' stroke-linejoin='round'%3e%3cpolyline points='6 9 12 15 18 9'%3e%3c/polyline%3e%3c/svg%3e"); background-repeat: no-repeat; background-position: right 1rem center; background-size: 1em; padding-right: 2.5rem; }

        input:focus, textarea:focus, select:focus { background: white; border-color: var(--primary); box-shadow: 0 0 0 3px var(--primary-soft); outline: none; }
        
        .grid-2 { display: grid; grid-template-columns: 1fr 1fr; gap: 25px; }
        .checkbox-group { display: flex; gap: 20px; flex-wrap: wrap; background: #f8fafc; padding: 20px; border-radius: 10px; border: 1px solid var(--border-color); }
        .checkbox-item { display: flex; align-items: center; gap: 8px; font-size: 0.95rem; cursor: pointer; }
        input[type="checkbox"] { width: 18px; height: 18px; accent-color: var(--primary); cursor: pointer; }

        /* Footer */
        footer { background: var(--bg-surface); padding: 15px 20px; border-top: 1px solid var(--border-color); display: flex; justify-content: center; flex-shrink: 0; padding-bottom: env(safe-area-inset-bottom); }
        .footer-content { width: 100%; max-width: 1200px; display: flex; justify-content: flex-end; gap: 15px; }

        /* Botões */
        .btn { background: var(--primary); color: white; border: none; padding: 12px 24px; border-radius: 50px; cursor: pointer; font-weight: 600; font-size: 0.95rem; box-shadow: var(--shadow-sm); display: inline-flex; align-items: center; gap: 8px; transition: 0.2s; }
        .btn:hover { background: var(--primary-dark); }
        .btn-outline { background: white; border: 1px solid var(--border-color); color: var(--text-main); padding: 8px 16px; border-radius: 8px; cursor: pointer; font-weight: 500; display: inline-flex; align-items: center; gap: 6px; transition: 0.2s; }
        .btn-outline:hover { background: #f8fafc; border-color: #cbd5e1; }
        .btn-ghost { background: transparent; border: none; cursor: pointer; color: var(--text-muted); padding: 8px 12px; font-size: 0.95rem; }
        .btn-danger { background: #fee2e2; color: #ef4444; border: none; padding: 8px 12px; border-radius: 8px; cursor: pointer; }
        
        .btn-save { background: #1e293b; color: white; border: none; padding: 10px 20px; border-radius: 8px; cursor: pointer; font-weight: 600; font-size: 0.9rem; display: inline-flex; align-items: center; gap: 8px; transition: 0.2s; box-shadow: var(--shadow-sm); }
        .btn-save:active { transform: scale(0.95); }

        /* --- ESTILOS ESPECÍFICOS --- */
        .student-table-container { overflow-x: auto; margin-top: 20px; border: 1px solid var(--border-color); border-radius: 10px; }
        .student-table { width: 100%; border-collapse: collapse; font-size: 0.9rem; min-width: 800px; }
        .student-table th { background-color: #f1f5f9; color: var(--text-main); font-weight: 600; padding: 12px; text-align: left; border-bottom: 1px solid var(--border-color); }
        .student-table td { padding: 12px; border-bottom: 1px solid var(--border-color); vertical-align: middle; }
        .student-table tr:last-child td { border-bottom: none; }
        
        .status-badge { padding: 4px 10px; border-radius: 50px; font-size: 0.75rem; font-weight: 700; color: white; display: inline-block; }
        .status-laudado { background-color: var(--status-green); }
        .status-investigacao { background-color: var(--status-orange); }
        .status-suspeita { background-color: var(--status-red); }
        
        .type-badge { padding: 4px 10px; border-radius: 6px; font-size: 0.75rem; font-weight: 600; color: #1e293b; display: inline-block; background: #e2e8f0; }
        .type-aluno { background: #dbeafe; color: #1e40af; }
        .type-pais { background: #fae8ff; color: #86198f; }
        .type-equipe { background: #ffedd5; color: #9a3412; }

        .action-bar { display: flex; gap: 10px; margin-top: 20px; flex-wrap: wrap; }

        /* Agenda & Ponto */
        .toggle-view-btn { background: #f1f5f9; color: var(--text-muted); padding: 8px 16px; border-radius: 50px; font-size: 0.9rem; font-weight: 600; cursor: pointer; border: 1px solid transparent; display:flex; gap:8px; align-items:center; }
        .toggle-view-btn.active { background: var(--text-main); color: white; }
        
        .agenda-controls { display: flex; flex-direction: column; gap: 15px; align-items: center; margin-bottom: 30px; max-width: 600px; margin-left: auto; margin-right: auto; }
        .agenda-nav { display: flex; justify-content: center; align-items: center; gap: 20px; background: white; padding: 10px; border-radius: 50px; border: 1px solid var(--border-color); width: 100%; box-shadow: var(--shadow-sm); }
        .week-history-selector { width: 100%; padding: 12px; border-radius: 12px; border: 1px solid var(--border-color); background: white; font-family: 'Inter', sans-serif; font-size: 1rem; color: var(--text-main); }
        
        .metrics-container { display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 15px; margin-bottom: 30px; }
        .metric-box { background: white; padding: 20px; border-radius: 12px; border: 1px solid var(--border-color); text-align: center; box-shadow: var(--shadow-sm); }
        .timesheet-table { width: 100%; border-collapse: separate; border-spacing: 0 10px; }
        .ts-row { background: white; box-shadow: var(--shadow-sm); border-radius: 12px; }
        .ts-row td { padding: 15px; vertical-align: middle; border-top: 1px solid var(--border-color); border-bottom: 1px solid var(--border-color); }
        .ts-row td:first-child { border-left: 1px solid var(--border-color); border-radius: 12px 0 0 12px; }
        .ts-row td:last-child { border-right: 1px solid var(--border-color); border-radius: 0 12px 12px 0; }
        .ts-input { text-align: center; width: 100%; border: 1px solid var(--border-color); padding: 8px; border-radius: 6px; }

        /* Modal & Toast */
        #modal-overlay { display: none; position: fixed; inset: 0; background: rgba(0,0,0,0.4); backdrop-filter: blur(4px); z-index: 3000; justify-content: center; align-items: center; }
        .modal-card { background: white; width: 90%; max-width: 600px; max-height: 85vh; border-radius: 20px; display: flex; flex-direction: column; box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.1); }
        .modal-body { flex: 1; overflow-y: auto; padding: 25px; background: #f8fafc; }
        .meeting-item { background: white; padding: 20px; border-radius: 12px; border: 1px solid var(--border-color); margin-bottom: 15px; box-shadow: var(--shadow-sm); }

        #toast-notification {
            position: fixed; top: 20px; left: 50%; transform: translateX(-50%);
            background: #1e293b; color: white; padding: 12px 24px; border-radius: 50px;
            font-weight: 600; box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1);
            display: flex; align-items: center; gap: 10px; z-index: 5000;
            opacity: 0; pointer-events: none; transition: 0.3s;
        }
        #toast-notification.show { opacity: 1; top: 40px; }

        @media (max-width: 1024px) {
            .login-box { width: 85%; padding: 2rem; }
            .week-bar { padding: 10px 0; }
            .section-card { padding: 25px; }
            .grid-2 { grid-template-columns: 1fr; }
            .timesheet-table thead { display: none; }
            .timesheet-table, tbody, tr, td { display: block; width: 100%; }
            .ts-row { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; padding: 15px; height: auto; margin-bottom: 15px; }
            .ts-row td { border: none !important; padding: 0 !important; text-align: left !important; }
            .ts-row td:first-child { grid-column: 1 / -1; margin-bottom: 5px; font-weight: 700; border-bottom: 1px solid #f1f5f9 !important; padding-bottom: 5px !important; }
            .ts-row td:nth-child(2) { grid-column: 1 / -1; margin-bottom: 5px; }
            .ts-row td:last-child { grid-column: 1 / -1; text-align: right !important; background: #f8fafc; padding: 10px !important; border-radius: 8px !important; margin-top: 5px; }
            .ts-row.holiday td.merged-cell { grid-column: 1 / -1; }
        }
    </style>
</head>
<body>

    <div id="toast-notification"><i class="fas fa-check-circle" style="color:#4ade80"></i> Alterações Salvas!</div>

    <div id="login-screen">
        <div class="login-box">
            <div style="font-size: 3rem; color: var(--primary); margin-bottom: 10px;"><i class="fas fa-fingerprint"></i></div>
            <h2 style="color:var(--text-main); margin-top:0; font-weight: 700;">Acesso Seguro</h2>
            <p style="color:var(--text-muted); font-size:0.95rem; margin-bottom:25px;">Seus dados ficam salvos apenas neste dispositivo.</p>
            <input type="password" id="password-input" class="login-input" placeholder="Digite sua senha">
            <button class="btn" onclick="checkPassword()" style="width:100%; justify-content: center; padding: 16px;">Entrar</button>
        </div>
    </div>

    <div id="app-container" style="display:none; flex-direction: column; height: 100%;">
        
        <header>
            <div class="header-content">
                <div id="header-dashboard">
                    <div class="brand-logo">
                        <i class="fas fa-shapes" style="color:var(--primary)"></i> Gestão Psi
                    </div>
                    
                    <div style="display:flex; background:#f1f5f9; padding:4px; border-radius:50px; margin: 0 10px;">
                        <button id="btn-view-schools" class="toggle-view-btn active" onclick="switchMainView('schools')"><i class="fas fa-book"></i> <span style="margin-left:5px">Diários</span></button>
                        <button id="btn-view-agenda" class="toggle-view-btn" onclick="switchMainView('agenda')"><i class="far fa-clock"></i> <span style="margin-left:5px">Ponto</span></button>
                    </div>

                    <button class="btn-save" onclick="saveManual()"><i class="fas fa-save"></i> Salvar</button>
                </div>

                <div id="header-school">
                    <div style="display:flex; align-items:center;">
                        <button class="btn-outline" onclick="showDashboard()" title="Voltar" style="margin-right:10px;">
                            <i class="fas fa-arrow-left"></i>
                        </button>
                        <h2 id="current-school-name" style="margin:0; font-size:1.1rem; max-width:150px; overflow:hidden; text-overflow:ellipsis; white-space:nowrap;">Escola</h2>
                    </div>
                    
                    <div style="display:flex; gap:8px;">
                        <button class="btn-save" onclick="saveManual()"><i class="fas fa-save"></i> Salvar</button>
                        <button class="btn-outline" onclick="openMeetings()"><i class="fas fa-users-cog"></i></button>
                        <button class="btn-danger" onclick="deleteSchool()"><i class="fas fa-trash-alt"></i></button>
                    </div>
                </div>
            </div>
        </header>

        <div id="app-content">
            
            <div id="dashboard-view">
                <div class="container-center">
                    <div class="section-header">
                        <h2>Minhas Escolas</h2>
                        <p style="color:var(--text-muted)">Gerencie seus diários e registros</p>
                    </div>
                    
                    <div class="school-grid" id="school-grid"></div>

                    <div style="text-align: center; margin-top: 50px;">
                        <button class="btn" onclick="addNewSchool()"><i class="fas fa-plus"></i> Nova Unidade</button>
                    </div>
                </div>
            </div>

            <div id="agenda-view" style="display:none;">
                <div class="container-center">
                    <div class="section-header" style="margin-bottom:20px;">
                        <h2>Controle de Ponto</h2>
                    </div>

                    <div class="agenda-controls">
                        <select id="week-history-selector" class="week-history-selector" onchange="jumpToWeek(this.value)">
                            <option value="">Carregando histórico...</option>
                        </select>

                        <div class="agenda-nav">
                            <button class="btn-ghost" onclick="changeWeek(-1)"><i class="fas fa-chevron-left"></i></button>
                            <div id="agenda-current-week-display" style="font-weight: 700; min-width: 140px; text-align: center;">Semana Atual</div>
                            <button class="btn-ghost" onclick="changeWeek(1)"><i class="fas fa-chevron-right"></i></button>
                        </div>
                    </div>

                    <div class="metrics-container">
                        <div class="metric-box">
                            <div class="metric-val" style="color:var(--primary); font-size:1.5rem; font-weight:700;" id="metric-done">00h 00m</div>
                            <div class="metric-lbl" style="font-size:0.8rem; color:var(--text-muted); margin-top:5px;">REALIZADO</div>
                        </div>
                        <div class="metric-box">
                            <div class="metric-val" style="color:var(--text-muted); font-size:1.5rem; font-weight:700;" id="metric-left">30h 00m</div>
                            <div class="metric-lbl" style="font-size:0.8rem; color:var(--text-muted); margin-top:5px;">META (30h)</div>
                        </div>
                        <div class="metric-box">
                            <div class="metric-val" id="metric-balance" style="font-size:1.5rem; font-weight:700;">00h 00m</div>
                            <div class="metric-lbl" style="font-size:0.8rem; color:var(--text-muted); margin-top:5px;">SALDO</div>
                        </div>
                    </div>

                    <div class="section-card">
                        <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:20px; flex-wrap:wrap; gap:10px;">
                            <h3 style="margin:0;">Registros</h3>
                            <button class="btn-outline" onclick="copyPreviousWeek()" style="font-size:0.85rem;"><i class="fas fa-copy"></i> Copiar Anterior</button>
                        </div>
                        <table class="timesheet-table">
                            <thead>
                                <tr style="text-align:left; color:var(--text-muted); font-size:0.85rem;">
                                    <th style="padding-left:15px">Dia</th>
                                    <th>Local</th>
                                    <th style="text-align:center;">Entrada</th>
                                    <th style="text-align:center;">Saída</th>
                                    <th style="text-align:center;">Pausa</th>
                                    <th style="text-align:right; padding-right:15px">Total</th>
                                </tr>
                            </thead>
                            <tbody id="agenda-body"></tbody>
                        </table>
                    </div>
                </div>
            </div>

            <div id="school-view">
                <div class="week-bar-container">
                    <div class="week-bar">
                        <div id="week-tabs" style="display:flex; gap:10px;"></div>
                        <button class="week-tab" style="color:var(--primary); background: rgba(13, 148, 136, 0.1);" onclick="addWeek()">+ Semana</button>
                    </div>
                </div>
                
                <div class="content-scroll">
                    <div class="form-container">
                        <input type="text" id="week-title-edit" class="week-title-editor" onchange="updateWeekName(this.value)">
                        <div id="form-container-inner"></div>
                        <div id="generic-buttons-container" style="margin-top:60px; text-align:center; padding-top:30px; border-top:2px dashed var(--border-color);">
                            <button class="btn-outline" onclick="addGenericTopic()" style="border-style: dashed;">+ Tópico Livre</button>
                        </div>
                    </div>
                </div>
            </div>

        </div>

        <footer>
            <div class="footer-content">
                <input type="file" id="import-file" hidden onchange="importData(this)">
                <button class="btn-ghost" onclick="document.getElementById('import-file').click()"><i class="fas fa-file-upload"></i> Restaurar</button>
                <button class="btn-ghost" onclick="exportData()"><i class="fas fa-download"></i> Backup</button>
            </div>
        </footer>

    </div>

    <div id="modal-overlay">
        <div class="modal-card">
            <div class="modal-header" style="padding: 20px; border-bottom: 1px solid #e2e8f0; display:flex; justify-content:space-between;">
                <h3 style="margin:0; font-size: 1.1rem;">Reuniões</h3>
                <button class="btn-ghost" onclick="closeMeetings()"><i class="fas fa-times"></i></button>
            </div>
            <div class="modal-body">
                <div style="text-align:center; margin-bottom:20px;">
                    <button class="btn" onclick="addMeeting()" style="width:100%"><i class="fas fa-plus"></i> Nova Reunião</button>
                </div>
                <div id="meetings-list"></div>
            </div>
        </div>
    </div>

    <script>
        // ==========================================
        // LÓGICA DO SISTEMA
        // ==========================================

        document.getElementById('password-input').addEventListener('keypress', (e) => {
            if(e.key === 'Enter') checkPassword();
        });

        // MODELOS DE DADOS
        const modeloSemana1 = { 
            type: 's1', 
            data: { 
                nome: '', endereco: '', 
                niveis: {infantil:false, fund1:false, fund2:false, medio:false, eja:false}, 
                alunos: '', turmas: '', 
                turnos: {mat:false, vesp:false, not:false, int:false}, 
                diretor: '', coord: '', orientador: '', 
                condicoes: '', espacos: '', recursos: '', acessibilidade: '', sala_psi: '', 
                queixa_gestao: '', queixa_profs: '', encaminhamentos: '' 
            }
        };

        const modeloSemana2 = { 
            type: 's2', 
            data: { 
                horarios: '', regras: '', comunicacao: '', conselhos: '', 
                rel_gp: '', rel_pa: '', rel_pp: '', rel_ef: '' 
            }
        };

        const modeloSemana3 = { 
            type: 's3', 
            data: { 
                ppp: '', indices: '', inclusao: '', 
                sintese: '', plano: '' 
            }
        };

        const genericTemplate = [ { title: 'Diário de Campo', content: '' } ];
        const baseDay = (dayName) => ({ day: dayName, local: '', in: '', out: '', pause: 0, isHoliday: false, credit: '' });
        const daysOfWeek = ['Seg','Ter','Qua','Qui','Sex'];

        function getInitialData() {
            const clone = (obj) => JSON.parse(JSON.stringify(obj));
            return {
                security: { hash: null },
                schools: [ { 
                    id: 1, 
                    name: "Escola Exemplo", 
                    desc: "Terça e Quinta", 
                    meetings: [], 
                    students: [], 
                    attendances: [],
                    weeks: [ 
                        { id: 1, name: "S1 - Identificação", content: clone(modeloSemana1), extra: [] },
                        { id: 2, name: "S2 - Clima", content: clone(modeloSemana2), extra: [] },
                        { id: 3, name: "S3 - Pedagógico", content: clone(modeloSemana3), extra: [] }
                    ] 
                } ],
                calendar: {}
            };
        }

        let appData = getInitialData();
        let currSchool = null;
        let currWeek = null; // 'students' ou 'attendance' se estiver nas abas especiais
        let currentAgendaOffset = 0; 
        let currentAgendaKey = "";

        async function sha256(str) { const buf = await crypto.subtle.digest("SHA-256", new TextEncoder().encode(str)); return Array.from(new Uint8Array(buf)).map(b => b.toString(16).padStart(2, "0")).join(""); }

        async function checkPassword() {
            const input = document.getElementById('password-input').value;
            const saved = localStorage.getItem('psicoGestao_v10'); // Versão atualizada storage key
            if(saved) {
                const parsed = JSON.parse(saved);
                if(!parsed.calendar && parsed.agenda) { const k = getWeekKey(0); parsed.calendar = {}; parsed.calendar[k] = parsed.agenda; delete parsed.agenda; }
                else if (!parsed.calendar) { parsed.calendar = {}; }
                
                // Migração
                parsed.schools.forEach(s => { 
                    if(!s.students) s.students = []; 
                    if(!s.attendances) s.attendances = []; // Inicializa novo array
                });

                if(parsed.security && parsed.security.hash) {
                    if(await sha256(input) === parsed.security.hash) { appData = parsed; enterApp(); } else alert("Senha incorreta.");
                } else setupPass(input);
            } else setupPass(input);
        }

        async function setupPass(pass) {
            if(pass.length < 4) return alert("Senha muito curta (min 4).");
            appData = getInitialData(); appData.security.hash = await sha256(pass); save(); enterApp();
        }

        function enterApp() {
            document.getElementById('login-screen').style.display = 'none';
            document.getElementById('app-container').style.display = 'flex';
            if(appData.lastViewedWeek) {
                currentAgendaKey = appData.lastViewedWeek;
            }
            renderDashboard();
        }

        function save() { 
            localStorage.setItem('psicoGestao_v10', JSON.stringify(appData)); 
        }

        function saveManual() {
            save();
            showToast();
        }

        function showToast() {
            const toast = document.getElementById('toast-notification');
            toast.classList.add('show');
            setTimeout(() => { toast.classList.remove('show'); }, 2000);
        }

        function switchMainView(view) {
            const dash = document.getElementById('dashboard-view');
            const agenda = document.getElementById('agenda-view');
            const btnS = document.getElementById('btn-view-schools');
            const btnA = document.getElementById('btn-view-agenda');
            const headerSchool = document.getElementById('header-school');
            const headerDash = document.getElementById('header-dashboard');

            if(view === 'schools') {
                dash.style.display = 'block'; agenda.style.display = 'none';
                btnS.classList.add('active'); btnA.classList.remove('active');
                if(!currSchool) { headerDash.style.display = 'flex'; headerSchool.style.display = 'none'; }
                renderDashboard();
            } else {
                dash.style.display = 'none'; agenda.style.display = 'block';
                btnS.classList.remove('active'); btnA.classList.add('active');
                headerDash.style.display = 'flex'; headerSchool.style.display = 'none';
                if(!currentAgendaKey) currentAgendaKey = getWeekKey(0);
                renderAgenda();
            }
        }

        function renderDashboard() {
            const grid = document.getElementById('school-grid'); grid.innerHTML = '';
            appData.schools.forEach((s, idx) => {
                const div = document.createElement('div'); div.className = 'school-card'; div.onclick = () => openSchool(idx);
                div.innerHTML = `<div><div style="display:flex; justify-content:space-between; align-items:start"><h3 style="color:var(--text-main); margin:0;">${s.name}</h3><i class="fas fa-school" style="color:var(--primary-soft); background: var(--primary); padding:8px; border-radius:50%; font-size: 0.8rem;"></i></div><p style="margin-top:5px; font-size:0.9rem; color:var(--text-muted);">${s.desc}</p></div><div style="font-size:0.85rem; color:var(--text-muted); margin-top:15px; border-top:1px solid var(--border-color); padding-top:10px; display:flex; justify-content:space-between;"><span>${s.weeks.length} semanas</span><span><i class="fas fa-chevron-right"></i></span></div>`;
                grid.appendChild(div);
            });
        }

        function addNewSchool() {
            const name = prompt("Nome da Escola:");
            if(name) {
                const desc = prompt("Descrição (Ex: Segunda e Terça):");
                const clone = (obj) => JSON.parse(JSON.stringify(obj));
                const newSchool = { 
                    id: Date.now(), name, desc, meetings: [], students: [], attendances: [],
                    weeks: [ { id: Date.now()+1, name: "S1 - Identificação", content: clone(modeloSemana1), extra: [] }, { id: Date.now()+2, name: "S2 - Clima", content: clone(modeloSemana2), extra: [] }, { id: Date.now()+3, name: "S3 - Pedagógico", content: clone(modeloSemana3), extra: [] } ] 
                };
                appData.schools.push(newSchool); save(); renderDashboard();
            }
        }
        function deleteSchool() { if(confirm("Apagar escola?")) { appData.schools.splice(currSchool, 1); save(); showDashboard(); } }
        function showDashboard() { currSchool = null; document.getElementById('school-view').style.display='none'; switchMainView('schools'); }

        // --- SISTEMA DE DATAS ---
        function getWeekKey(offset) {
            const d = new Date(); 
            const day = d.getDay(); 
            const diff = d.getDate() - day + (day == 0 ? -6 : 1);
            const monday = new Date(d.setDate(diff)); 
            monday.setDate(monday.getDate() + (offset * 7));
            return monday.toISOString().split('T')[0];
        }
        
        function formatWeekKeyToLabel(key) {
            if(!key) return "Semana";
            const parts = key.split('-');
            const monday = new Date(parts[0], parts[1]-1, parts[2]);
            const friday = new Date(monday); friday.setDate(friday.getDate() + 4);
            const fmt = (date) => `${String(date.getDate()).padStart(2,'0')}/${String(date.getMonth()+1).padStart(2,'0')}`;
            return `${fmt(monday)} a ${fmt(friday)}`;
        }

        function updateWeekSelector() {
            const selector = document.getElementById('week-history-selector');
            selector.innerHTML = '';
            const keys = Object.keys(appData.calendar).sort().reverse();
            let allKeys = [...new Set([currentAgendaKey, ...keys])].sort().reverse();

            allKeys.forEach(key => {
                const option = document.createElement('option');
                option.value = key;
                option.text = formatWeekKeyToLabel(key) + (appData.calendar[key] ? " (Salvo)" : " (Novo)");
                if(key === currentAgendaKey) option.selected = true;
                selector.appendChild(option);
            });
        }

        function jumpToWeek(key) {
            currentAgendaKey = key;
            const todayKey = getWeekKey(0);
            if(key === todayKey) currentAgendaOffset = 0; 
            renderAgenda();
        }

        function renderAgenda() {
            if(!currentAgendaKey) currentAgendaKey = getWeekKey(0);
            if(!appData.calendar[currentAgendaKey]) {
                 appData.calendar[currentAgendaKey] = daysOfWeek.map(d => baseDay(d));
            }
            
            const currentData = appData.calendar[currentAgendaKey];
            const tbody = document.getElementById('agenda-body'); tbody.innerHTML = '';
            let totalMins = 0;
            
            document.getElementById('agenda-current-week-display').innerText = formatWeekKeyToLabel(currentAgendaKey);
            updateWeekSelector();

            currentData.forEach((day, idx) => {
                let mins = 0; let inputsHTML = ''; const rowClass = day.isHoliday ? 'ts-row holiday' : 'ts-row';
                if(day.isHoliday) {
                    if(day.credit) { const [h, m] = day.credit.split(':').map(Number); mins = (h*60) + m; }
                    inputsHTML = `<td colspan="3" class="merged-cell" style="text-align:center; padding: 10px;"><div style="display:flex; justify-content:center; align-items:center; gap:10px;"><span style="font-weight:700; color:var(--primary); font-size:0.9rem;">ABONO:</span><input type="time" class="ts-input" value="${day.credit}" onchange="upAg('${currentAgendaKey}',${idx},'credit',this.value)" style="max-width:120px; background:white;"></div></td>`;
                } else {
                    if(day.in && day.out) { const [h1, m1] = day.in.split(':').map(Number); const [h2, m2] = day.out.split(':').map(Number); let diff = (h2*60 + m2) - (h1*60 + m1); if(day.pause) diff -= parseInt(day.pause); if(diff > 0) mins = diff; }
                    inputsHTML = `<td style="text-align:center"><input type="time" class="ts-input" value="${day.in}" onchange="upAg('${currentAgendaKey}',${idx},'in',this.value)"></td><td style="text-align:center"><input type="time" class="ts-input" value="${day.out}" onchange="upAg('${currentAgendaKey}',${idx},'out',this.value)"></td><td style="text-align:center"><input type="number" class="ts-input" placeholder="0" value="${day.pause}" onchange="upAg('${currentAgendaKey}',${idx},'pause',this.value)" style="width:70px"></td>`;
                }
                totalMins += mins; const h = Math.floor(mins/60); const m = mins%60; const txt = `${h}h ${m.toString().padStart(2,'0')}m`;
                tbody.innerHTML += `<tr class="${rowClass}"><td><div style="display:flex; align-items:center; justify-content:space-between;">${day.day}<button class="btn-holiday ${day.isHoliday?'active':''}" onclick="toggleHoliday('${currentAgendaKey}',${idx})"><i class="fas fa-umbrella-beach"></i></button></div></td><td><input type="text" class="ts-input ts-input-local" placeholder="Local" value="${day.local}" onchange="upAg('${currentAgendaKey}',${idx},'local',this.value)"></td>${inputsHTML}<td style="font-weight:700; color:var(--primary); text-align:right;">${txt}</td></tr>`;
            });

            const target = 30 * 60; const left = target - totalMins;
            const fmt = (m) => `${Math.floor(Math.abs(m)/60)}h ${Math.abs(m)%60}m`;
            document.getElementById('metric-done').innerText = fmt(totalMins);
            document.getElementById('metric-left').innerText = left > 0 ? fmt(left) : '0h 0m';
            const bal = document.getElementById('metric-balance');
            if(left > 0) { bal.innerText = "-" + fmt(left); bal.style.color = "#ef4444"; } else { bal.innerText = "+" + fmt(left); bal.style.color = "#0d9488"; }
            
            appData.lastViewedWeek = currentAgendaKey;
            save();
        }

        function toggleHoliday(key, idx) { appData.calendar[key][idx].isHoliday = !appData.calendar[key][idx].isHoliday; if(appData.calendar[key][idx].isHoliday) { appData.calendar[key][idx].in = ''; appData.calendar[key][idx].out = ''; appData.calendar[key][idx].pause = 0; } save(); renderAgenda(); }
        function upAg(key, idx, field, val) { appData.calendar[key][idx][field] = val; save(); renderAgenda(); }
        
        function copyPreviousWeek() { 
            if(!currentAgendaKey) return;
            const parts = currentAgendaKey.split('-');
            const currDate = new Date(parts[0], parts[1]-1, parts[2]);
            const prevDate = new Date(currDate); prevDate.setDate(prevDate.getDate() - 7);
            const prevKey = prevDate.toISOString().split('T')[0];
            if(!appData.calendar[prevKey]) return alert("Não encontrei dados na semana imediatamente anterior."); 
            if(confirm("Copiar semana anterior?")) { appData.calendar[currentAgendaKey] = JSON.parse(JSON.stringify(appData.calendar[prevKey])).map(d => ({...d, isHoliday: false, credit: ''})); saveManual(); renderAgenda(); } 
        }

        function changeWeek(dir) { 
            if(!currentAgendaKey) currentAgendaKey = getWeekKey(0);
            const parts = currentAgendaKey.split('-');
            const currentMonday = new Date(parts[0], parts[1]-1, parts[2]);
            currentMonday.setDate(currentMonday.getDate() + (dir * 7));
            currentAgendaKey = currentMonday.toISOString().split('T')[0];
            renderAgenda(); 
        }

        // --- LÓGICA DE ESCOLAS & ABAS ---

        function openSchool(idx) {
            currSchool = idx; currWeek = 0;
            document.getElementById('dashboard-view').style.display = 'none'; document.getElementById('agenda-view').style.display = 'none';
            document.getElementById('school-view').style.display = 'flex'; 
            document.getElementById('header-dashboard').style.display = 'none';
            document.getElementById('header-school').style.display = 'flex';
            document.getElementById('current-school-name').innerText = appData.schools[idx].name; renderWeeks();
        }

        function renderWeeks() {
            const container = document.getElementById('week-tabs'); container.innerHTML = '';
            
            // Abas de Semanas (Diários)
            appData.schools[currSchool].weeks.forEach((w, idx) => {
                const btn = document.createElement('button'); 
                let shortName = w.name; if(w.name.includes("-")) shortName = w.name.split("-")[0];
                btn.className = `week-tab ${idx === currWeek ? 'active' : ''}`; 
                btn.innerText = shortName; 
                btn.onclick = () => { currWeek = idx; renderWeeks(); };
                container.appendChild(btn);
            });
            
            // Aba de Alunos (Mapeamento)
            const btnAlunos = document.createElement('button');
            btnAlunos.className = `week-tab tab-special ${currWeek === 'students' ? 'active' : ''}`;
            btnAlunos.innerHTML = '<i class="fas fa-list-ul"></i> Mapeamento';
            btnAlunos.onclick = () => { currWeek = 'students'; renderWeeks(); };
            container.appendChild(btnAlunos);

            // NOVA ABA: Escuta & Demandas
            const btnEscuta = document.createElement('button');
            btnEscuta.className = `week-tab tab-special-2 ${currWeek === 'attendance' ? 'active' : ''}`;
            btnEscuta.innerHTML = '<i class="fas fa-comments"></i> Escuta/Demandas';
            btnEscuta.onclick = () => { currWeek = 'attendance'; renderWeeks(); };
            container.appendChild(btnEscuta);

            if(currWeek === 'students') renderStudentsView();
            else if (currWeek === 'attendance') renderAttendanceView();
            else renderForm();
        }

        function addWeek() { const num = appData.schools[currSchool].weeks.length + 1; const newTopics = JSON.parse(JSON.stringify(genericTemplate)); appData.schools[currSchool].weeks.push({ id: Date.now(), name: `Semana ${num}`, content: { type: 'generic', data: {} }, extra: newTopics }); currWeek = appData.schools[currSchool].weeks.length - 1; save(); renderWeeks(); }
        function updateWeekName(val) { appData.schools[currSchool].weeks[currWeek].name = val; save(); renderWeeks(); }

        // --- ABA DE ESCUTA/DEMANDAS (NOVA FUNCIONALIDADE) ---

        function renderAttendanceView() {
            document.getElementById('week-title-edit').style.display = 'none';
            document.getElementById('generic-buttons-container').style.display = 'none';

            const container = document.getElementById('form-container-inner');
            container.innerHTML = `
                <div class="section-card" style="border-left: 5px solid #3b82f6;">
                    <div class="section-title" style="color:#1e40af">Registro de Atendimento e Escuta Institucional</div>
                    <p style="color:var(--text-muted); font-size:0.9rem; margin-bottom:20px;">
                        Espaço destinado ao registro de queixas pontuais, atendimentos breves a pais, grupos ou equipe escolar.
                    </p>

                    <div class="grid-2">
                        <div class="form-group">
                            <label>Data do Atendimento</label>
                            <input type="date" id="att_date" value="${new Date().toISOString().slice(0,10)}">
                        </div>
                        <div class="form-group">
                            <label>Público Alvo / Quem?</label>
                            <select id="att_type">
                                <option value="Aluno (Individual)">Aluno (Individual)</option>
                                <option value="Grupo de Alunos">Grupo de Alunos</option>
                                <option value="Família/Pais">Família / Pais / Responsáveis</option>
                                <option value="Equipe/Funcionário">Professor / Equipe / Funcionário</option>
                            </select>
                        </div>
                    </div>

                    <div class="form-group">
                        <label>Nome(s) dos Envolvidos</label>
                        <input type="text" id="att_names" placeholder="Ex: João Silva (5º B) e Maria Souza">
                    </div>

                    <div class="form-group">
                        <label>Demanda / Queixa Principal</label>
                        <textarea id="att_demand" rows="3" placeholder="Qual o motivo da escuta? (Ex: Conflito em sala, dúvida sobre comportamento, solicitação da coordenação...)"></textarea>
                    </div>

                    <div class="form-group">
                        <label>Orientação / Manejo / Encaminhamento</label>
                        <textarea id="att_action" rows="3" placeholder="O que foi feito? (Ex: Escuta acolhedora, orientação aos pais, encaminhamento ao CRAS, mediação de conflito...)"></textarea>
                    </div>

                    <div style="text-align:right;">
                        <button class="btn" style="background:#1e40af;" onclick="addAttendance()">Salvar Registro</button>
                    </div>
                </div>

                <div id="attendance-list-area">
                    <h3 style="color:var(--text-main); margin-bottom:15px; display:flex; align-items:center; gap:10px;">
                        <i class="fas fa-history" style="color:#cbd5e1"></i> Histórico de Escutas
                    </h3>
                    <div class="student-table-container">
                        <table class="student-table">
                            <thead>
                                <tr>
                                    <th style="width:100px;">Data</th>
                                    <th style="width:140px;">Público</th>
                                    <th>Nome / Demanda</th>
                                    <th>Ações / Manejo</th>
                                    <th style="width:50px;"></th>
                                </tr>
                            </thead>
                            <tbody id="attendance-table-body"></tbody>
                        </table>
                    </div>
                </div>
            `;
            renderAttendanceTable();
        }

        function addAttendance() {
            const date = document.getElementById('att_date').value;
            const type = document.getElementById('att_type').value;
            const names = document.getElementById('att_names').value;
            const demand = document.getElementById('att_demand').value;
            const action = document.getElementById('att_action').value;

            if(!names || !demand) return alert("Preencha ao menos o nome e a demanda.");

            const newAtt = {
                id: Date.now(),
                date, type, names, demand, action
            };

            if(!appData.schools[currSchool].attendances) appData.schools[currSchool].attendances = [];
            appData.schools[currSchool].attendances.unshift(newAtt); // Adiciona no topo
            save();

            // Limpa campos
            document.getElementById('att_names').value = '';
            document.getElementById('att_demand').value = '';
            document.getElementById('att_action').value = '';
            showToast();
            renderAttendanceTable();
        }

        function renderAttendanceTable() {
            const tbody = document.getElementById('attendance-table-body');
            if(!tbody) return;
            tbody.innerHTML = '';
            const list = appData.schools[currSchool].attendances || [];

            if(list.length === 0) {
                tbody.innerHTML = '<tr><td colspan="5" style="text-align:center; padding:20px; color:var(--text-muted);">Nenhum registro de escuta ainda.</td></tr>';
                return;
            }

            list.forEach((item, idx) => {
                let badgeClass = 'type-badge';
                if(item.type.includes('Aluno')) badgeClass += ' type-aluno';
                else if(item.type.includes('Pais') || item.type.includes('Família')) badgeClass += ' type-pais';
                else if(item.type.includes('Equipe')) badgeClass += ' type-equipe';

                const dateParts = item.date.split('-');
                const dateFmt = `${dateParts[2]}/${dateParts[1]}`;

                tbody.innerHTML += `
                    <tr>
                        <td style="font-weight:600; color:var(--text-muted);">${dateFmt}</td>
                        <td><span class="${badgeClass}">${item.type}</span></td>
                        <td>
                            <strong>${item.names}</strong><br>
                            <span style="font-size:0.85rem; color:#475569;">${item.demand}</span>
                        </td>
                        <td style="font-size:0.85rem; color:#475569;">${item.action || '-'}</td>
                        <td>
                            <button class="btn-ghost" style="color:#ef4444;" onclick="removeAttendance(${idx})"><i class="fas fa-trash"></i></button>
                        </td>
                    </tr>
                `;
            });
        }

        function removeAttendance(idx) {
            if(confirm("Remover este registro?")) {
                appData.schools[currSchool].attendances.splice(idx, 1);
                save();
                renderAttendanceTable();
            }
        }


        // --- RENDERIZAÇÃO DO LEVANTAMENTO DE ALUNOS (Mantido) ---

        function renderStudentsView() {
            document.getElementById('week-title-edit').style.display = 'none';
            document.getElementById('generic-buttons-container').style.display = 'none';
            
            const container = document.getElementById('form-container-inner');
            container.innerHTML = `
                <div class="section-card" id="student-form-section">
                    <div class="section-title">Mapeamento e Triagem de Alunos (NEE)</div>
                    
                    <div class="row" style="display:flex; gap:15px; flex-wrap:wrap; margin-bottom:15px;">
                        <div style="flex:2; min-width:200px;">
                            <label>Nome do Aluno</label>
                            <input type="text" id="std_nome" placeholder="Nome completo">
                        </div>
                        <div style="flex:1; min-width:120px;">
                            <label>Série/Ano</label>
                            <input type="text" id="std_serie" placeholder="Ex: 5º Ano B">
                        </div>
                        <div style="flex:1; min-width:120px;">
                            <label>Turno</label>
                            <select id="std_turno">
                                <option value="Manhã">Manhã</option>
                                <option value="Tarde">Tarde</option>
                                <option value="Integral">Integral</option>
                                <option value="Noite">Noite</option>
                            </select>
                        </div>
                    </div>

                    <div class="row" style="display:flex; gap:15px; flex-wrap:wrap; margin-bottom:15px;">
                        <div style="flex:1; min-width:200px;">
                            <label>Professor(a) Fonte</label>
                            <input type="text" id="std_prof" placeholder="Quem passou a informação?">
                        </div>
                        <div style="flex:1; min-width:200px;">
                            <label>Status Atual</label>
                            <select id="std_status">
                                <option value="Em Investigação">Em Investigação</option>
                                <option value="Laudado">Já Laudado (Tem Diagnóstico)</option>
                                <option value="Suspeita da Escola">Suspeita da Escola (Sem ação da família)</option>
                            </select>
                        </div>
                    </div>

                    <div class="row" style="display:flex; gap:15px; flex-wrap:wrap; margin-bottom:15px;">
                        <div style="flex:1; min-width:200px;">
                            <label>Hipótese ou Diagnóstico</label>
                            <input type="text" id="std_hipotese" placeholder="Ex: TEA, TDAH, Atraso...">
                        </div>
                        <div style="flex:1; min-width:200px;">
                            <label>Adesão da Família</label>
                            <select id="std_familia">
                                <option value="Boa Adesão">Boa Adesão</option>
                                <option value="Parcial/Oscilante">Parcial / Oscilante</option>
                                <option value="Resistente/Negação">Resistente / Negação</option>
                                <option value="Desconhecido">Não sei informar</option>
                            </select>
                        </div>
                    </div>

                    <div class="form-group">
                        <label>Observações Relevantes (Breve)</label>
                        <textarea id="std_obs" rows="2" placeholder="Ex: Família não aceita encaminhamento..."></textarea>
                    </div>

                    <div class="action-bar">
                        <button class="btn" onclick="addStudent()">➕ Adicionar Aluno</button>
                        <button class="btn-outline" style="color:#27ae60; border-color:#27ae60" onclick="exportStudentsCSV()">📥 Excel/CSV</button>
                        <button class="btn-outline" style="color:#c0392b; border-color:#c0392b" onclick="exportStudentsPDF()">📄 Baixar PDF</button>
                    </div>
                </div>

                <div id="pdf-content-area">
                    <h2 style="text-align:center; font-size:1.4rem; color:var(--primary-dark); margin-bottom:20px;">Levantamento de Alunos - ${appData.schools[currSchool].name}</h2>
                    <div class="student-table-container">
                        <table class="student-table">
                            <thead>
                                <tr>
                                    <th>Nome</th>
                                    <th>Série</th>
                                    <th>Status</th>
                                    <th>Hipótese/Diag.</th>
                                    <th>Família</th>
                                    <th>Ações</th>
                                </tr>
                            </thead>
                            <tbody id="student-table-body">
                            </tbody>
                        </table>
                    </div>
                </div>
            `;
            renderStudentTable();
        }

        function addStudent() {
            const nome = document.getElementById('std_nome').value;
            if(!nome) return alert("Nome é obrigatório");

            const newStudent = {
                id: Date.now(),
                nome: nome,
                serie: document.getElementById('std_serie').value,
                turno: document.getElementById('std_turno').value,
                professor: document.getElementById('std_prof').value,
                status: document.getElementById('std_status').value,
                hipotese: document.getElementById('std_hipotese').value,
                familia: document.getElementById('std_familia').value,
                obs: document.getElementById('std_obs').value
            };

            if(!appData.schools[currSchool].students) appData.schools[currSchool].students = [];
            appData.schools[currSchool].students.push(newStudent);
            save();
            
            document.getElementById('std_nome').value = '';
            document.getElementById('std_hipotese').value = '';
            document.getElementById('std_obs').value = '';
            document.getElementById('std_nome').focus();
            
            renderStudentTable();
            showToast();
        }

        function renderStudentTable() {
            const tbody = document.getElementById('student-table-body');
            if(!tbody) return;
            tbody.innerHTML = '';
            
            const students = appData.schools[currSchool].students || [];

            if(students.length === 0) {
                tbody.innerHTML = '<tr><td colspan="6" style="text-align:center; color:var(--text-muted);">Nenhum aluno registrado.</td></tr>';
                return;
            }

            students.forEach((s, idx) => {
                let statusClass = 'status-suspeita';
                if(s.status === 'Laudado') statusClass = 'status-laudado';
                else if(s.status === 'Em Investigação') statusClass = 'status-investigacao';

                tbody.innerHTML += `
                    <tr>
                        <td>
                            <strong>${s.nome}</strong>
                            <div style="font-size:0.8rem; color:var(--text-muted); margin-top:2px;">Turno: ${s.turno}</div>
                        </td>
                        <td>${s.serie}</td>
                        <td><span class="status-badge ${statusClass}">${s.status}</span></td>
                        <td>${s.hipotese}</td>
                        <td>${s.familia}</td>
                        <td>
                            <button class="btn-danger" style="padding: 6px 10px;" onclick="removeStudent(${idx})"><i class="fas fa-trash"></i></button>
                        </td>
                    </tr>
                    <tr style="background:#fcfcfc;">
                        <td colspan="6" style="padding: 8px 12px; font-size:0.85rem; color:var(--text-muted); border-bottom:2px solid #f1f5f9;">
                            <strong>Obs:</strong> ${s.obs || "Sem observações."} | <strong>Prof:</strong> ${s.professor || "-"}
                        </td>
                    </tr>
                `;
            });
        }

        function removeStudent(idx) {
            if(confirm("Remover este aluno da lista?")) {
                appData.schools[currSchool].students.splice(idx, 1);
                save();
                renderStudentTable();
            }
        }

        function exportStudentsCSV() {
            const students = appData.schools[currSchool].students || [];
            if(students.length === 0) return alert("Lista vazia.");
            
            let csv = ["Nome,Série,Turno,Professor,Status,Hipótese,Família,Observações"];
            students.forEach(s => {
                const row = [
                    `"${s.nome}"`, `"${s.serie}"`, `"${s.turno}"`, `"${s.professor}"`,
                    `"${s.status}"`, `"${s.hipotese}"`, `"${s.familia}"`, `"${s.obs}"`
                ];
                csv.push(row.join(","));
            });

            const csvFile = new Blob(["\uFEFF" + csv.join("\n")], {type: "text/csv;charset=utf-8;"});
            const link = document.createElement("a");
            link.download = `Levantamento_${appData.schools[currSchool].name.replace(/\s/g,'_')}.csv`;
            link.href = window.URL.createObjectURL(csvFile);
            link.click();
        }

        function exportStudentsPDF() {
            const element = document.getElementById('pdf-content-area');
            const btns = document.querySelectorAll('.btn-danger'); // Esconder botões de excluir
            btns.forEach(b => b.style.display = 'none');

            const options = {
                margin: 10,
                filename: `Alunos_${appData.schools[currSchool].name}.pdf`,
                image: { type: 'jpeg', quality: 0.98 },
                html2canvas: { scale: 2 },
                jsPDF: { unit: 'mm', format: 'a4', orientation: 'landscape' }
            };

            html2pdf().set(options).from(element).save().then(() => {
                btns.forEach(b => b.style.display = 'inline-block'); // Volta botões
            });
        }


        // --- FORMULÁRIOS DAS SEMANAS (Mantido) ---

        function renderForm() {
            document.getElementById('week-title-edit').style.display = 'block';
            document.getElementById('generic-buttons-container').style.display = 'block';

            const week = appData.schools[currSchool].weeks[currWeek]; 
            document.getElementById('week-title-edit').value = week.name;
            const c = document.getElementById('form-container-inner'); c.innerHTML = '';
            if(week.content.type === 's1') formS1(week.content.data, c); else if(week.content.type === 's2') formS2(week.content.data, c); else if(week.content.type === 's3') formS3(week.content.data, c);
            if(!week.extra) week.extra = []; week.extra.forEach((t, idx) => formGeneric(t, idx, c));
        }

        function formS1(d, c) {
            c.innerHTML += `
            <div class="section-card">
                <div class="section-title">1. Identificação e Dados Gerais</div>
                <div class="form-group"><label>Nome da Escola</label><input type="text" value="${d.nome}" oninput="upD('nome', this.value)"></div>
                <div class="form-group"><label>Endereço/Bairro</label><input type="text" value="${d.endereco}" oninput="upD('endereco', this.value)"></div>
                <div class="form-group"><label>Níveis de Ensino</label><div class="checkbox-group">
                    <label class="checkbox-item"><input type="checkbox" ${d.niveis.infantil?'checked':''} onchange="upC('niveis','infantil',this.checked)">Ed. Infantil</label>
                    <label class="checkbox-item"><input type="checkbox" ${d.niveis.fund1?'checked':''} onchange="upC('niveis','fund1',this.checked)">Fund. I</label>
                    <label class="checkbox-item"><input type="checkbox" ${d.niveis.fund2?'checked':''} onchange="upC('niveis','fund2',this.checked)">Fund. II</label>
                    <label class="checkbox-item"><input type="checkbox" ${d.niveis.medio?'checked':''} onchange="upC('niveis','medio',this.checked)">Médio</label>
                    <label class="checkbox-item"><input type="checkbox" ${d.niveis.eja?'checked':''} onchange="upC('niveis','eja',this.checked)">EJA</label>
                </div></div>
                <div class="grid-2">
                    <div class="form-group"><label>Número de Alunos</label><input type="text" value="${d.alunos}" oninput="upD('alunos',this.value)"></div>
                    <div class="form-group"><label>Número de Turmas</label><input type="text" value="${d.turmas}" oninput="upD('turmas',this.value)"></div>
                </div>
                <div class="form-group"><label>Turnos de Funcionamento</label><div class="checkbox-group">
                    <label class="checkbox-item"><input type="checkbox" ${d.turnos.mat?'checked':''} onchange="upC('turnos','mat',this.checked)">Matutino</label>
                    <label class="checkbox-item"><input type="checkbox" ${d.turnos.vesp?'checked':''} onchange="upC('turnos','vesp',this.checked)">Vespertino</label>
                    <label class="checkbox-item"><input type="checkbox" ${d.turnos.not?'checked':''} onchange="upC('turnos','not',this.checked)">Noturno</label>
                    <label class="checkbox-item"><input type="checkbox" ${d.turnos.int?'checked':''} onchange="upC('turnos','int',this.checked)">Integral</label>
                </div></div>
                <div class="form-group"><label>Equipe Gestora</label>
                    <div style="display:flex; flex-direction:column; gap:10px;">
                        <input type="text" placeholder="Diretor(a)" value="${d.diretor}" oninput="upD('diretor',this.value)">
                        <input type="text" placeholder="Coord. Pedagógico(a)" value="${d.coord}" oninput="upD('coord',this.value)">
                        <input type="text" placeholder="Orientador(a) Educacional" value="${d.orientador}" oninput="upD('orientador',this.value)">
                    </div>
                </div>
            </div>
            
            <div class="section-card">
                <div class="section-title">2. Infraestrutura e Ambiente Físico</div>
                <div class="form-group"><label>Condições Gerais</label><textarea rows="3" placeholder="Limpeza, iluminação, ventilação, conservação..." oninput="upD('condicoes',this.value)">${d.condicoes}</textarea></div>
                <div class="form-group"><label>Espaços de Convivência</label><textarea rows="3" placeholder="Pátio, quadra, biblioteca, refeitório... como são usados?" oninput="upD('espacos',this.value)">${d.espacos}</textarea></div>
                <div class="form-group"><label>Recursos Pedagógicos</label><textarea rows="3" placeholder="Sala de recursos, laboratórios, biblioteca, internet..." oninput="upD('recursos',this.value)">${d.recursos}</textarea></div>
                <div class="form-group"><label>Acessibilidade</label><textarea rows="3" placeholder="Escola adaptada para deficientes físicos?" oninput="upD('acessibilidade',this.value)">${d.acessibilidade}</textarea></div>
                <div class="form-group"><label>Sala da Psicologia/Atendimento</label><textarea rows="3" placeholder="Existe espaço reservado para escuta sigilosa?" oninput="upD('sala_psi',this.value)">${d.sala_psi}</textarea></div>
            </div>

            <div class="section-card">
                <div class="section-title">6. Levantamento de Demandas e Queixas</div>
                <div class="form-group"><label>Queixa Principal da Gestão</label><textarea rows="3" placeholder="O que esperam do psicólogo?" oninput="upD('queixa_gestao',this.value)">${d.queixa_gestao}</textarea></div>
                <div class="form-group"><label>Queixa Principal dos Professores</label><textarea rows="3" placeholder="Dificuldades de aprendizagem, indisciplina, desmotivação..." oninput="upD('queixa_profs',this.value)">${d.queixa_profs}</textarea></div>
                <div class="form-group"><label>Principais Encaminhamentos</label><textarea rows="3" placeholder="Conselho Tutelar, CRAS, Saúde?" oninput="upD('encaminhamentos',this.value)">${d.encaminhamentos}</textarea></div>
            </div>`;
        }

        function formS2(d, c) {
            c.innerHTML += `
            <div class="section-card">
                <div class="section-title">3. Organização e Rotina Escolar</div>
                <div class="form-group"><label>Horários Críticos</label><textarea rows="3" placeholder="Entrada, saída, recreio. Onde há desorganização?" oninput="upD('horarios',this.value)">${d.horarios}</textarea></div>
                <div class="form-group"><label>Regras e Normas</label><textarea rows="3" placeholder="Regimento claro? Construído coletivamente?" oninput="upD('regras',this.value)">${d.regras}</textarea></div>
                <div class="form-group"><label>Comunicação</label><textarea rows="3" placeholder="Entre direção/professores e com pais?" oninput="upD('comunicacao',this.value)">${d.comunicacao}</textarea></div>
                <div class="form-group"><label>Conselhos de Classe</label><textarea rows="3" placeholder="Focam apenas em notas/comportamento?" oninput="upD('conselhos',this.value)">${d.conselhos}</textarea></div>
            </div>
            
            <div class="section-card">
                <div class="section-title">5. Clima Escolar e Relações Interpessoais</div>
                <div class="grid-2">
                    <div class="form-group"><label>Relação Gestão-Professores</label><textarea rows="3" placeholder="Democrática, autoritária, parceira?" oninput="upD('rel_gp',this.value)">${d.rel_gp}</textarea></div>
                    <div class="form-group"><label>Relação Professor-Aluno</label><textarea rows="3" placeholder="Respeito, medo, afeto?" oninput="upD('rel_pa',this.value)">${d.rel_pa}</textarea></div>
                </div>
                <div class="form-group"><label>Relação entre Pares (Alunos)</label><textarea rows="3" placeholder="Grupos isolados? Bullying?" oninput="upD('rel_pp',this.value)">${d.rel_pp}</textarea></div>
                <div class="form-group"><label>Relação Escola-Família</label><textarea rows="3" placeholder="Pais participam?" oninput="upD('rel_ef',this.value)">${d.rel_ef}</textarea></div>
            </div>`;
        }

        function formS3(d, c) {
            c.innerHTML += `
            <div class="section-card">
                <div class="section-title">4. Aspectos Pedagógicos e Documentais</div>
                <div class="form-group"><label>Projeto Político-Pedagógico (PPP)</label><textarea rows="3" placeholder="Existe? Atualizado? Prática condiz com documento?" oninput="upD('ppp',this.value)">${d.ppp}</textarea></div>
                <div class="form-group"><label>Índices de Desempenho</label><textarea rows="3" placeholder="Aprovação, reprovação, evasão." oninput="upD('indices',this.value)">${d.indices}</textarea></div>
                <div class="form-group"><label>Inclusão Escolar</label><textarea rows="3" placeholder="Quantos alunos? Quais deficiências? Relação professor-aluno?" oninput="upD('inclusao',this.value)">${d.inclusao}</textarea></div>
            </div>
            <div class="section-card">
                <div class="section-title">Síntese Diagnóstica</div>
                <div class="form-group"><label>Diagnóstico Preliminar</label><textarea rows="4" placeholder="Resumo das observações." oninput="upD('sintese',this.value)">${d.sintese}</textarea></div>
                <div class="form-group"><label>Plano de Ação</label><textarea rows="4" placeholder="Por onde começar?" oninput="upD('plano',this.value)">${d.plano}</textarea></div>
            </div>`;
        }

        function formGeneric(t, idx, c) { c.innerHTML += `<div class="section-card generic-topic" style="padding:0;"><div class="generic-header" style="background:#f1f5f9; padding:15px; border-bottom:1px solid var(--border-color); display:flex; justify-content:space-between;"><input type="text" class="generic-title-input" style="font-size:1rem; padding:0; background:transparent; border:none; color:var(--primary-dark); font-weight:700;" value="${t.title}" onchange="upXT(${idx},this.value)"><button class="btn-danger" style="background:transparent; border:none; color:#ef4444;" onclick="delX(${idx})"><i class="fas fa-trash-alt"></i></button></div><div class="generic-body" style="padding:20px;"><textarea rows="4" oninput="upXC(${idx},this.value)" placeholder="Escreva aqui..." style="border:none; background:transparent; width:100%; outline:none;">${t.content}</textarea></div></div>`; }
        
        function upD(k, v) { appData.schools[currSchool].weeks[currWeek].content.data[k] = v; save(); }
        function upC(ok, k, v) { appData.schools[currSchool].weeks[currWeek].content.data[ok][k] = v; save(); }
        function upXT(i, v) { appData.schools[currSchool].weeks[currWeek].extra[i].title = v; save(); }
        function upXC(i, v) { appData.schools[currSchool].weeks[currWeek].extra[i].content = v; save(); }
        function addGenericTopic() { appData.schools[currSchool].weeks[currWeek].extra.push({title:'Nota', content:''}); save(); renderForm(); }
        function delX(i) { if(confirm("Apagar?")) { appData.schools[currSchool].weeks[currWeek].extra.splice(i,1); save(); renderForm(); }}

        function openMeetings() { document.getElementById('modal-overlay').style.display = 'flex'; renderMeetings(); }
        function closeMeetings() { document.getElementById('modal-overlay').style.display = 'none'; }
        function renderMeetings() { const list = document.getElementById('meetings-list'); list.innerHTML = ''; const meetings = appData.schools[currSchool].meetings || []; if(meetings.length===0) list.innerHTML='<div style="text-align:center;color:var(--text-muted); margin-top:20px;">Sem reuniões.</div>'; meetings.forEach((m, i) => { list.innerHTML += `<div class="meeting-item"><div style="display:flex; justify-content:space-between; margin-bottom:10px;"><input type="date" value="${m.date}" onchange="upMeet(${i},'date',this.value)" style="border:none; font-weight:700; color:var(--primary); font-family:Inter, sans-serif;"><button class="btn-danger" style="padding:4px 8px;" onclick="delMeet(${i})"><i class="fas fa-trash"></i></button></div><textarea rows="3" placeholder="Pauta..." oninput="upMeet(${i},'text',this.value)" style="width:100%;">${m.text}</textarea></div>`; }); }
        function addMeeting() { if(!appData.schools[currSchool].meetings) appData.schools[currSchool].meetings=[]; appData.schools[currSchool].meetings.unshift({date:new Date().toISOString().slice(0,10),part:'',text:''}); save(); renderMeetings(); }
        function upMeet(i,k,v) { appData.schools[currSchool].meetings[i][k]=v; save(); }
        function delMeet(i) { if(confirm("Apagar?")) { appData.schools[currSchool].meetings.splice(i,1); save(); renderMeetings(); }}
        
        function exportData() { const dataStr = JSON.stringify(appData); const dataUri = 'data:application/json;charset=utf-8,'+ encodeURIComponent(dataStr); let link = document.createElement('a'); link.setAttribute('href', dataUri); link.setAttribute('download', 'Backup_PsiEscolar.json'); link.click(); }
        function importData(input) { const file = input.files[0]; if(!file) return; const reader = new FileReader(); reader.onload = (e) => { try { const d = JSON.parse(e.target.result); if(confirm("Substituir dados atuais?")) { appData=d; save(); location.reload(); } } catch(err) { alert("Arquivo inválido."); } }; reader.readAsText(file); }
    </script>
</body>
</html>